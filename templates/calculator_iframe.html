<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Salary Package Calculator</title>
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body {
      font-family: 'Ubuntu', sans-serif;
      background-color: #f8f9fa;
      font-size: 0.9rem;
      margin: 0;
      padding: 0;
    }
    
    .header-band {
      background: linear-gradient(135deg, #045c84 0%, #207088 50%, #f47c04 100%);
      color: white;
      padding: 1rem 0;
      margin-bottom: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .header-band h2 {
      margin: 0;
      font-weight: bold;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
      font-size: 1.3rem;
    }
    
    .tile-section {
      border: 1px solid #dee2e6;
      border-radius: 8px;
      background-color: white;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .section-header {
      background: linear-gradient(135deg, #207088 0%, #045c84 100%);
      color: white;
      padding: 0.5rem 1rem;
      margin: -1rem -1rem 1rem -1rem;
      border-radius: 8px 8px 0 0;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      font-weight: bold;
    }
    
    .sap-data-section {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      padding: 0.5rem 1rem;
      margin: -1rem -1rem 1rem -1rem;
      border-radius: 8px 8px 0 0;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      font-weight: bold;
    }
    
    .locked-field {
      background-color: #e9ecef;
      border: 1px solid #ced4da;
      color: #6c757d;
      cursor: not-allowed;
    }
    
    .editable-field {
      background-color: #fff;
      border: 1px solid #28a745;
    }
    
    .running-total {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border: 2px solid #dee2e6;
      border-radius: 6px;
      padding: 0.75rem;
      margin-top: 1rem;
      text-align: center;
      font-weight: bold;
    }
    
    .running-total.earnings {
      border-color: #28a745;
      background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
      color: #155724;
    }
    
    .running-total.deductions {
      border-color: #dc3545;
      background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
      color: #721c24;
    }
    
    .running-total.employer {
      border-color: #ffc107;
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      color: #856404;
    }
    
    .net-pay-highlight {
      font-size: 1.5rem;
      font-weight: bold;
      color: #f47c04;
    }
    
    .ctc-highlight {
      font-size: 1.3rem;
      font-weight: bold;
      color: #1e3a5f;
    }
    
    .action-buttons {
      position: sticky;
      bottom: 0;
      background: white;
      border-top: 2px solid #dee2e6;
      padding: 1rem;
      margin: 1rem -1rem -1rem -1rem;
      border-radius: 0 0 8px 8px;
    }
    
    .status-indicator {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: bold;
    }
    
    .status-draft { background-color: #fff3cd; color: #856404; }
    .status-saved { background-color: #d1ecf1; color: #0c5460; }
    .status-submitted { background-color: #d4edda; color: #155724; }
    
    .form-control, .form-select {
      padding: 0.375rem 0.5rem;
      font-size: 0.85rem;
    }
    
    .form-label {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
  </style>
</head>
<body>

<div class="container-fluid">
  <!-- Header -->
  <div class="header-band">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h2>üí∞ Salary Package Calculator</h2>
        <small>Design your ideal compensation package</small>
      </div>
      <div class="col-md-4 text-end">
        <span class="status-indicator status-draft" id="status-indicator">Draft</span>
      </div>
    </div>
  </div>

  <!-- SAP Data Section -->
  <div class="tile-section">
    <div class="sap-data-section">
      üìä SAP Data Integration
    </div>
    <div class="row g-2">
      <div class="col-md-6">
        <button type="button" class="btn btn-success btn-sm" id="load-sap-data-btn">
          üîÑ Load from SAP
        </button>
        <small class="text-muted d-block mt-1">Pull current package data from SAP</small>
      </div>
      <div class="col-md-6">
        <button type="button" class="btn btn-primary btn-sm" id="submit-to-sap-btn" disabled>
          üì§ Submit to SAP
        </button>
        <small class="text-muted d-block mt-1">Submit final package to SAP</small>
      </div>
    </div>
  </div>

  <!-- Personal Details -->
  <div class="tile-section">
    <div class="section-header">
      üë§ Personal Details
    </div>
    <div class="row g-2">
      <div class="col-md-3">
        <label class="form-label">First Name</label>
        <input type="text" class="form-control locked-field" id="first_name" readonly>
      </div>
      <div class="col-md-3">
        <label class="form-label">Surname</label>
        <input type="text" class="form-control locked-field" id="surname" readonly>
      </div>
      <div class="col-md-3">
        <label class="form-label">Employee ID</label>
        <input type="text" class="form-control locked-field" id="employee_id" readonly>
      </div>
      <div class="col-md-3">
        <label class="form-label">Email</label>
        <input type="email" class="form-control locked-field" id="email" readonly>
      </div>
      <div class="col-md-4">
        <label class="form-label">Job Title</label>
        <input type="text" class="form-control locked-field" id="job_title" readonly>
      </div>
      <div class="col-md-4">
        <label class="form-label">Department</label>
        <input type="text" class="form-control locked-field" id="department" readonly>
      </div>
      <div class="col-md-4">
        <label class="form-label">Current CTC (SAP)</label>
        <input type="text" class="form-control locked-field" id="current_ctc" readonly>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Earnings and Employer -->
    <div class="col-md-6">
      <div class="tile-section">
        <div class="section-header">
          üí∞ Earnings
        </div>
        
        <!-- Basic Salary (Locked from SAP) -->
        <div class="mb-3">
          <label for="basic_salary" class="form-label fw-bold text-primary">Basic Salary (SAP):</label>
          <input type="number" class="form-control locked-field" id="basic_salary" readonly>
          <small class="text-muted">Locked - cannot be changed</small>
        </div>
        
        <!-- Additional Allowances (Editable) -->
        <div class="mb-3">
          <label class="form-label fw-bold text-success">Additional Allowances:</label>
          <div id="allowances-list"></div>
          <div class="row g-2 mt-2">
            <div class="col-8">
              <select id="allowance-dropdown" class="form-select">
                <option value="">Select allowance to add</option>
                <option value="Travel Allowance">Travel Allowance</option>
                <option value="Cellphone Allowance">Cellphone Allowance</option>
                <option value="Internet Allowance">Internet Allowance</option>
                <option value="Entertainment Allowance">Entertainment Allowance</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="col-3">
              <input type="number" class="form-control" id="allowance-value" placeholder="Amount" style="display: none;">
            </div>
            <div class="col-1">
              <button type="button" class="btn btn-success btn-sm" id="add-allowance-btn" style="display: none;">+</button>
            </div>
          </div>
        </div>
        
        <!-- Running Total for Earnings -->
        <div class="running-total earnings">
          Total Earnings: R <span id="total-earnings">0.00</span>
        </div>
      </div>

      <div class="tile-section">
        <div class="section-header">
          üè¢ Employer Contributions
        </div>
        
        <!-- SAP Employer Contributions (Locked) -->
        <div class="mb-3">
          <label class="form-label fw-bold text-primary">SAP Employer Contributions:</label>
          <div id="sap-employer-list"></div>
        </div>
        
        <!-- Additional Employer Contributions (Editable) -->
        <div class="mb-3">
          <label class="form-label fw-bold text-success">Additional Employer Contributions:</label>
          <div id="additional-employer-list"></div>
          <div class="row g-2 mt-2">
            <div class="col-8">
              <select id="employer-dropdown" class="form-select">
                <option value="">Select contribution to add</option>
                <option value="Additional Pension">Additional Pension</option>
                <option value="Group Life">Group Life</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="col-3">
              <input type="number" class="form-control" id="employer-value" placeholder="Amount" style="display: none;">
            </div>
            <div class="col-1">
              <button type="button" class="btn btn-success btn-sm" id="add-employer-btn" style="display: none;">+</button>
            </div>
          </div>
        </div>
        
        <!-- Running Total for Employer -->
        <div class="running-total employer">
          Total Employer: R <span id="total-employer">0.00</span>
        </div>
      </div>
    </div>

    <!-- Deductions and Net Pay -->
    <div class="col-md-6">
      <div class="tile-section">
        <div class="section-header">
          üí∏ Deductions
        </div>
        
        <!-- SAP Deductions (Locked) -->
        <div class="mb-3">
          <label class="form-label fw-bold text-primary">SAP Deductions:</label>
          <div id="sap-deductions-list"></div>
        </div>
        
        <!-- Additional Deductions (Editable) -->
        <div class="mb-3">
          <label class="form-label fw-bold text-success">Additional Deductions:</label>
          <div id="additional-deductions-list"></div>
          <div class="row g-2 mt-2">
            <div class="col-8">
              <select id="deduction-dropdown" class="form-select">
                <option value="">Select deduction to add</option>
                <option value="Additional Pension">Additional Pension</option>
                <option value="Medical Aid">Medical Aid</option>
                <option value="Union">Union</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="col-3">
              <input type="number" class="form-control" id="deduction-value" placeholder="Amount" style="display: none;">
            </div>
            <div class="col-1">
              <button type="button" class="btn btn-success btn-sm" id="add-deduction-btn" style="display: none;">+</button>
            </div>
          </div>
        </div>
        
        <!-- Running Total for Deductions -->
        <div class="running-total deductions">
          Total Deductions: R <span id="total-deductions">0.00</span>
        </div>
      </div>

      <div class="tile-section">
        <div class="section-header">
          üíº Cost to Company
        </div>
        <div class="ctc-highlight">R <span id="ctc_total_val">0.00</span></div>
      </div>

      <div class="tile-section">
        <div class="section-header">
          üí∞ Net Pay
        </div>
        <div class="net-pay-highlight">R <span id="net_pay_val">0.00</span></div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="action-buttons">
    <div class="row g-2">
      <div class="col-md-3">
        <button type="button" class="btn btn-secondary w-100" id="save-draft-btn">
          üíæ Save Draft
        </button>
      </div>
      <div class="col-md-3">
        <button type="button" class="btn btn-info w-100" id="print-offer-btn">
          üñ®Ô∏è Print Offer
        </button>
      </div>
      <div class="col-md-3">
        <button type="button" class="btn btn-warning w-100" id="preview-payslip-btn">
          üìÑ Preview Payslip
        </button>
      </div>
      <div class="col-md-3">
        <button type="button" class="btn btn-success w-100" id="submit-package-btn">
          ‚úÖ Submit Package
        </button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // Get employee ID from URL parameters or parent window
  const urlParams = new URLSearchParams(window.location.search);
  const employeeId = urlParams.get('employee_id') || 'DEMO001';
  
  // Initialize the calculator
  initializeCalculator(employeeId);
  
  // Load SAP data button
  document.getElementById('load-sap-data-btn').addEventListener('click', function() {
    loadSAPData(employeeId);
  });
  
  // Submit to SAP button
  document.getElementById('submit-to-sap-btn').addEventListener('click', function() {
    submitToSAP(employeeId);
  });
  
  // Save draft button
  document.getElementById('save-draft-btn').addEventListener('click', function() {
    saveDraft(employeeId);
  });
  
  // Submit package button
  document.getElementById('submit-package-btn').addEventListener('click', function() {
    submitPackage(employeeId);
  });
  
  // Print offer button
  document.getElementById('print-offer-btn').addEventListener('click', function() {
    printOffer();
  });
  
  // Preview payslip button
  document.getElementById('preview-payslip-btn').addEventListener('click', function() {
    previewPayslip();
  });
  
  // Initialize dropdown functionality
  initializeDropdowns();
  
  // Load initial data
  loadSAPData(employeeId);
});

function initializeCalculator(employeeId) {
  // Set employee ID
  document.getElementById('employee_id').value = employeeId;
  
  // Load any saved draft
  loadDraft(employeeId);
}

function loadSAPData(employeeId) {
  // Show loading state
  document.getElementById('load-sap-data-btn').innerHTML = '‚è≥ Loading...';
  document.getElementById('load-sap-data-btn').disabled = true;
  
  // Fetch employee data from SAP
  fetch(`/api/employee/${employeeId}`)
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        throw new Error(data.error);
      }
      
      // Populate personal details
      document.getElementById('first_name').value = data.first_name || '';
      document.getElementById('surname').value = data.surname || '';
      document.getElementById('email').value = data.email || '';
      document.getElementById('job_title').value = data.job_title || '';
      document.getElementById('department').value = data.department || '';
      document.getElementById('current_ctc').value = formatCurrency(data.ctc || 0);
      
      // Populate basic salary (locked)
      document.getElementById('basic_salary').value = data.basic_salary || 0;
      
      // Populate SAP allowances
      populateSAPAllowances(data.allowances || []);
      
      // Populate SAP deductions
      populateSAPDeductions(data.deductions || []);
      
      // Populate SAP employer contributions
      populateSAPEmployer(data.employer_contributions || []);
      
      // Update calculations
      updateTotals();
      
      // Update status
      updateStatus('saved');
      
    })
    .catch(error => {
      console.error('Error loading SAP data:', error);
      alert('Failed to load SAP data. Using demo data instead.');
      
      // Load demo data
      loadDemoData();
    })
    .finally(() => {
      // Reset button state
      document.getElementById('load-sap-data-btn').innerHTML = 'üîÑ Load from SAP';
      document.getElementById('load-sap-data-btn').disabled = false;
    });
}

function loadDemoData() {
  // Demo data for testing
  const demoData = {
    first_name: 'John',
    surname: 'Doe',
    email: 'john.doe@company.com',
    job_title: 'Software Developer',
    department: 'IT',
    basic_salary: 25000,
    ctc: 350000,
    allowances: [
      { name: 'Travel Allowance', amount: 2000 },
      { name: 'Cellphone Allowance', amount: 500 }
    ],
    deductions: [
      { name: 'Pension/Provident/RA', amount: 2500 },
      { name: 'Medical Aid', amount: 1200 }
    ],
    employer_contributions: [
      { name: 'Pension/Provident/RA', amount: 2500 },
      { name: 'Medical Aid', amount: 1200 },
      { name: 'UIF', amount: 250 }
    ]
  };
  
  // Populate fields
  document.getElementById('first_name').value = demoData.first_name;
  document.getElementById('surname').value = demoData.surname;
  document.getElementById('email').value = demoData.email;
  document.getElementById('job_title').value = demoData.job_title;
  document.getElementById('department').value = demoData.department;
  document.getElementById('current_ctc').value = formatCurrency(demoData.ctc);
  document.getElementById('basic_salary').value = demoData.basic_salary;
  
  populateSAPAllowances(demoData.allowances);
  populateSAPDeductions(demoData.deductions);
  populateSAPEmployer(demoData.employer_contributions);
  
  updateTotals();
  updateStatus('saved');
}

function populateSAPAllowances(allowances) {
  const container = document.getElementById('allowances-list');
  container.innerHTML = '';
  
  allowances.forEach(allowance => {
    const item = document.createElement('div');
    item.className = 'mb-2 p-2 bg-light border rounded';
    item.innerHTML = `
      <div class="d-flex justify-content-between align-items-center">
        <span class="fw-bold">${allowance.name}:</span>
        <span class="text-success">R ${formatCurrency(allowance.amount)}</span>
      </div>
    `;
    container.appendChild(item);
  });
}

function populateSAPDeductions(deductions) {
  const container = document.getElementById('sap-deductions-list');
  container.innerHTML = '';
  
  deductions.forEach(deduction => {
    const item = document.createElement('div');
    item.className = 'mb-2 p-2 bg-light border rounded';
    item.innerHTML = `
      <div class="d-flex justify-content-between align-items-center">
        <span class="fw-bold">${deduction.name}:</span>
        <span class="text-danger">R ${formatCurrency(deduction.amount)}</span>
      </div>
    `;
    container.appendChild(item);
  });
}

function populateSAPEmployer(contributions) {
  const container = document.getElementById('sap-employer-list');
  container.innerHTML = '';
  
  contributions.forEach(contribution => {
    const item = document.createElement('div');
    item.className = 'mb-2 p-2 bg-light border rounded';
    item.innerHTML = `
      <div class="d-flex justify-content-between align-items-center">
        <span class="fw-bold">${contribution.name}:</span>
        <span class="text-warning">R ${formatCurrency(contribution.amount)}</span>
      </div>
    `;
    container.appendChild(item);
  });
}

function initializeDropdowns() {
  // Allowance dropdown
  document.getElementById('allowance-dropdown').addEventListener('change', function() {
    const valueInput = document.getElementById('allowance-value');
    const addBtn = document.getElementById('add-allowance-btn');
    
    if (this.value) {
      valueInput.style.display = 'block';
      addBtn.style.display = 'block';
      valueInput.focus();
    } else {
      valueInput.style.display = 'none';
      addBtn.style.display = 'none';
      valueInput.value = '';
    }
  });
  
  // Add allowance button
  document.getElementById('add-allowance-btn').addEventListener('click', function() {
    addAllowance();
  });
  
  // Similar for deductions and employer contributions...
  // (Implementation similar to the original basic_form.html)
}

function addAllowance() {
  const dropdown = document.getElementById('allowance-dropdown');
  const valueInput = document.getElementById('allowance-value');
  const container = document.getElementById('additional-employer-list');
  
  if (dropdown.value && valueInput.value) {
    const item = document.createElement('div');
    item.className = 'mb-2 p-2 bg-success bg-opacity-10 border border-success rounded';
    item.innerHTML = `
      <div class="d-flex justify-content-between align-items-center">
        <span class="fw-bold">${dropdown.value}:</span>
        <div>
          <span class="text-success me-2">R ${formatCurrency(valueInput.value)}</span>
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.parentElement.parentElement.remove(); updateTotals();">√ó</button>
        </div>
      </div>
    `;
    container.appendChild(item);
    
    // Reset inputs
    dropdown.value = '';
    valueInput.value = '';
    valueInput.style.display = 'none';
    document.getElementById('add-allowance-btn').style.display = 'none';
    
    updateTotals();
  }
}

function updateTotals() {
  // Calculate totals based on all components
  const basicSalary = parseFloat(document.getElementById('basic_salary').value) || 0;
  
  // Calculate additional allowances
  const additionalAllowances = Array.from(document.querySelectorAll('#additional-employer-list .text-success'))
    .map(el => parseFloat(el.textContent.replace('R ', '').replace(',', '')) || 0);
  
  const totalEarnings = basicSalary + additionalAllowances.reduce((sum, val) => sum + val, 0);
  
  // Update display
  document.getElementById('total-earnings').textContent = formatCurrency(totalEarnings);
  
  // Similar calculations for deductions and employer contributions...
  // (Implementation would be similar to the original)
  
  // Calculate net pay
  const totalDeductions = 0; // Calculate from all deduction sources
  const netPay = totalEarnings - totalDeductions;
  document.getElementById('net_pay_val').textContent = formatCurrency(netPay);
  
  // Calculate CTC
  const totalEmployer = 0; // Calculate from all employer sources
  const ctc = totalEarnings + totalEmployer;
  document.getElementById('ctc_total_val').textContent = formatCurrency(ctc);
}

function updateStatus(status) {
  const indicator = document.getElementById('status-indicator');
  indicator.className = `status-indicator status-${status}`;
  
  switch(status) {
    case 'draft':
      indicator.textContent = 'Draft';
      break;
    case 'saved':
      indicator.textContent = 'Saved';
      break;
    case 'submitted':
      indicator.textContent = 'Submitted';
      document.getElementById('submit-to-sap-btn').disabled = false;
      break;
  }
}

function saveDraft(employeeId) {
  const packageData = collectPackageData();
  
  // Save to localStorage
  localStorage.setItem(`draft_${employeeId}`, JSON.stringify(packageData));
  
  updateStatus('saved');
  alert('Draft saved successfully!');
}

function loadDraft(employeeId) {
  const savedData = localStorage.getItem(`draft_${employeeId}`);
  if (savedData) {
    const data = JSON.parse(savedData);
    // Restore form data
    // Implementation would restore all form fields
    updateStatus('saved');
  }
}

function submitPackage(employeeId) {
  const packageData = collectPackageData();
  
  // Submit to backend
  fetch('/api/package/submit', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      employee_id: employeeId,
      package_data: packageData
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      throw new Error(data.error);
    }
    
    updateStatus('submitted');
    alert('Package submitted successfully!');
  })
  .catch(error => {
    console.error('Error submitting package:', error);
    alert('Failed to submit package. Please try again.');
  });
}

function submitToSAP(employeeId) {
  // This would trigger the SAP export functionality
  alert('Package will be exported to SAP. Please download the export file and upload it to SAP.');
}

function collectPackageData() {
  return {
    employee_id: document.getElementById('employee_id').value,
    basic_salary: document.getElementById('basic_salary').value,
    total_earnings: document.getElementById('total-earnings').textContent,
    total_deductions: document.getElementById('total-deductions').textContent,
    total_employer: document.getElementById('total-employer').textContent,
    net_pay: document.getElementById('net_pay_val').textContent,
    ctc: document.getElementById('ctc_total_val').textContent,
    submission_date: new Date().toISOString()
  };
}

function formatCurrency(amount) {
  return parseFloat(amount).toLocaleString('en-ZA', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
}

function printOffer() {
  // Implementation for printing offer
  alert('Print functionality would generate a PDF offer letter');
}

function previewPayslip() {
  // Implementation for payslip preview
  alert('Payslip preview would show a mock payslip');
}
</script>

</body>
</html> 