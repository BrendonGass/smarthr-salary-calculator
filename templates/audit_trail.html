<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Audit Trail - Rand Water</title>
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --randwater-primary: #0066CC;
      --randwater-secondary: #00A3E0;
    }
    
    body {
      font-family: 'Ubuntu', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
    }
    
    .header {
      background: linear-gradient(135deg, var(--randwater-primary) 0%, var(--randwater-secondary) 100%);
      color: white;
      padding: 20px 0;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }
    
    .container {
      max-width: 1400px;
    }
    
    .report-card {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }
    
    .filter-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .back-btn {
      color: white;
      text-decoration: none;
      padding: 10px 20px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.2);
      transition: all 0.3s;
      display: inline-block;
      margin-bottom: 20px;
    }
    
    .back-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      color: white;
    }
    
    .audit-entry {
      border-left: 4px solid #0066CC;
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      transition: all 0.3s;
    }
    
    .audit-entry:hover {
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      transform: translateX(5px);
    }
    
    .audit-entry.create {
      border-left-color: #28a745;
    }
    
    .audit-entry.update {
      border-left-color: #ffc107;
    }
    
    .audit-entry.delete {
      border-left-color: #dc3545;
    }
    
    .audit-meta {
      font-size: 0.85rem;
      color: #6c757d;
    }
    
    .change-detail {
      background: white;
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
      font-family: monospace;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="container">
      <a href="{{ url_for('randwater_admin_panel') }}" class="back-btn">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </a>
      <h2><i class="fas fa-clipboard-list"></i> Full Audit Trail</h2>
      <p class="mb-0">Complete history of all system changes</p>
    </div>
  </div>

  <div class="container">
    <div class="report-card">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4><i class="fas fa-filter"></i> Filter Audit Log</h4>
        <button class="btn btn-success" onclick="exportToCSV()">
          <i class="fas fa-download"></i> Export to CSV
        </button>
      </div>
      
      <div class="filter-section">
        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label"><strong>Date From</strong></label>
            <input type="date" id="dateFrom" class="form-control">
          </div>
          
          <div class="col-md-3">
            <label class="form-label"><strong>Date To</strong></label>
            <input type="date" id="dateTo" class="form-control">
          </div>
          
          <div class="col-md-3">
            <label class="form-label"><strong>User</strong></label>
            <select id="userFilter" class="form-select">
              <option value="all">All Users</option>
              <option value="randwateradmin">randwateradmin</option>
              <option value="admin">admin</option>
            </select>
          </div>
          
          <div class="col-md-3">
            <label class="form-label"><strong>Action Type</strong></label>
            <select id="actionFilter" class="form-select">
              <option value="all">All Actions</option>
              <option value="create">Create</option>
              <option value="update">Update</option>
              <option value="delete">Delete</option>
              <option value="submit">Submit</option>
            </select>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-12 text-end">
            <button class="btn btn-secondary" onclick="resetFilters()">
              <i class="fas fa-undo"></i> Reset
            </button>
            <button class="btn btn-primary" onclick="applyFilters()">
              <i class="fas fa-search"></i> Apply Filters
            </button>
          </div>
        </div>
      </div>

      <!-- Audit Log Entries -->
      <div id="auditLogContainer">
        <h5 class="mb-3"><i class="fas fa-history"></i> Recent Activity</h5>
        <p class="text-muted" id="logCount">Showing {{ audit_logs|length }} entries</p>
        
        <div id="auditEntries">
          {% if audit_logs %}
            {% for log in audit_logs %}
            <div class="audit-entry {{ log.action|lower }}">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="mb-1">
                    <span class="badge bg-primary">{{ log.action|upper }}</span>
                    <strong>{{ log.employee_id }}</strong> - {{ log.description or 'Package modification' }}
                  </h6>
                  <div class="audit-meta">
                    <i class="fas fa-user"></i> {{ log.admin_username or 'System' }} 
                    | <i class="fas fa-clock"></i> {{ log.timestamp }}
                  </div>
                </div>
                <div>
                  <button class="btn btn-sm btn-outline-primary" onclick="toggleDetails('{{ loop.index }}')">
                    <i class="fas fa-eye"></i> Details
                  </button>
                </div>
              </div>
              
              <div id="details-{{ loop.index }}" class="change-detail" style="display: none;">
                <strong>Changes:</strong><br>
                {% if log.changes %}
                  {{ log.changes|tojson(indent=2) }}
                {% else %}
                  No detailed changes recorded
                {% endif %}
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="text-center text-muted py-5">
              <i class="fas fa-inbox fa-3x mb-3"></i>
              <p>No audit log entries found</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    function toggleDetails(index) {
      $(`#details-${index}`).slideToggle();
    }
    
    function resetFilters() {
      $('#dateFrom').val('');
      $('#dateTo').val('');
      $('#userFilter').val('all');
      $('#actionFilter').val('all');
      location.reload();
    }
    
    function applyFilters() {
      const dateFrom = $('#dateFrom').val();
      const dateTo = $('#dateTo').val();
      const user = $('#userFilter').val();
      const action = $('#actionFilter').val();
      
      // Filter audit entries client-side
      $('.audit-entry').each(function() {
        let show = true;
        
        // Add filter logic here
        if (action !== 'all' && !$(this).hasClass(action)) {
          show = false;
        }
        
        $(this).toggle(show);
      });
      
      // Update count
      const visibleCount = $('.audit-entry:visible').length;
      $('#logCount').text(`Showing ${visibleCount} entries`);
    }
    
    function exportToCSV() {
      alert('Exporting audit trail to CSV...');
      window.open('/export_audit_trail_csv', '_blank');
    }
  </script>
</body>
</html>

