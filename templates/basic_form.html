<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Negotiator ‚Äì Basic Salary Mode</title>
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    body {
      font-family: 'Ubuntu', sans-serif;
      background-color: #f4f4f4;
      font-size: 0.9rem;
    }
    
    /* Colored header band */
    .header-band {
      background: linear-gradient(135deg, #045c84 0%, #207088 50%, #f47c04 100%);
      color: white;
      padding: 1.5rem 0;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .header-band h2 {
      margin: 0;
      font-weight: bold;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
      font-size: 1.5rem;
    }
    
    .header-band img {
      max-height: 120px;
      filter: brightness(0) invert(1);
    }
    
    .accordion-button {
      background-color: #207088;
      color: white;
      font-weight: bold;
      font-size: 1rem;
    }
    .accordion-body {
      background-color: white;
      padding: 0.75rem;
    }
    .tile-section {
      border: 1px solid #ccc;
      border-radius: 8px;
      background-color: white;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    
    /* Enhanced section headers with colored bands */
    .section-header {
      background: linear-gradient(135deg, #207088 0%, #045c84 100%);
      color: white;
      padding: 0.75rem 1rem;
      margin: -1rem -1rem 1rem -1rem;
      border-radius: 8px 8px 0 0;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1rem;
      font-weight: bold;
    }
    
    .section-header img {
      width: 20px;
      filter: brightness(0) invert(1);
    }
    
    .grey-box {
      background-color: #eee;
      padding: 0.4rem;
      border-radius: 4px;
      font-weight: bold;
      color: #666;
      font-size: 0.85rem;
    }
    
    /* Running totals */
    .running-total {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border: 2px solid #dee2e6;
      border-radius: 6px;
      padding: 0.75rem;
      margin-top: 1rem;
      text-align: center;
      font-weight: bold;
    }
    
    .running-total.earnings {
      border-color: #28a745;
      background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
      color: #155724;
    }
    
    .running-total.deductions {
      border-color: #dc3545;
      background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
      color: #721c24;
    }
    
    .running-total.employer {
      border-color: #ffc107;
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      color: #856404;
    }
    
    .running-total.netpay {
      border-color: #f47c04;
      background: linear-gradient(135deg, #ffe6cc 0%, #ffd699 100%);
      color: #cc6600;
    }
    
    /* Pensionable salary input - smaller */
    #pensionable_percent {
      max-width: 150px;
    }
    
    /* Pension toggle styling */
    .pension-toggle {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 0.5rem;
      font-size: 0.85rem;
    }
    
    .toggle-btn {
      padding: 0.25rem 0.5rem;
      border: 1px solid #dee2e6;
      background-color: #f8f9fa;
      cursor: pointer;
      border-radius: 4px;
      font-size: 0.8rem;
    }
    
    .toggle-btn.active {
      background-color: #207088;
      color: white;
      border-color: #207088;
    }
    
    /* Pension calculation display */
    .pension-calc {
      background-color: #e3f2fd;
      border: 1px solid #2196f3;
      border-radius: 4px;
      padding: 0.5rem;
      margin-top: 0.5rem;
      font-size: 0.85rem;
      color: #1976d2;
      display: none;
    }
    
    /* Dynamic item styling */
    .dynamic-item {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 0.5rem;
      margin-bottom: 0.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
    }
    
    .dynamic-item input {
      flex: 1;
    }
    
    .remove-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 3px;
      padding: 0.2rem 0.4rem;
      cursor: pointer;
      font-size: 0.7rem;
    }
    
    .remove-btn:hover {
      background-color: #c82333;
    }
    
    /* Dependants field */
    .dependants-field {
      display: none;
      margin-top: 0.5rem;
      padding: 0.5rem;
      background-color: #f8f9fa;
      border-radius: 4px;
      border-left: 3px solid #207088;
      font-size: 0.85rem;
    }
    
    /* Compact form styling */
    .form-control, .form-select {
      padding: 0.375rem 0.5rem;
      font-size: 0.85rem;
    }
    
    .form-label {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    
    .section-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1rem;
      font-weight: bold;
      color: #207088;
      margin-bottom: 0.5rem;
    }
    
    .net-pay-highlight {
      font-size: 1.5rem;
      font-weight: bold;
      color: #f47c04;
    }
    
    .ctc-highlight {
      font-size: 1.3rem;
      font-weight: bold;
      color: #1e3a5f;
    }
    
    /* Age display */
    .age-display {
      background-color: #e3f2fd;
      color: #1976d2;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: bold;
      display: inline-block;
      margin-left: 0.5rem;
    }
    
    #popup {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: url('/static/images/popup-bg.jpg') center center/cover no-repeat;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #popup::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0,0,0,0.6);
    }
    #popup-content {
      position: relative;
      z-index: 2;
      background: white;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 450px;
      text-align: center;
    }
    #popup-content img.logo {
      max-height: 140px;
      margin-bottom: 1rem;
    }
    .popup-footer {
      margin-top: 1rem;
    }
    .popup-footer img {
      width: 30px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<!-- POPUP -->
<div id="popup">
  <div id="popup-content">
    <img src="/static/images/gosmarthr-logo.png" class="logo" alt="SmartHR logo">
    <h4>Welcome to The Negotiator</h4>
    <form id="popup-form">
      <input type="text" id="popup-id" class="form-control mb-3" placeholder="ID Number or Username" required>
      <button type="submit" class="btn btn-primary w-100">Get Started</button>
    </form>

  </div>
</div>

<!-- OPEN OFFERS MODAL -->
<div id="open-offers-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); z-index: 10000;">
  <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 10px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4>üìÅ Open Saved Offers</h4>
      <button type="button" class="btn-close" onclick="closeOpenOffersModal()"></button>
    </div>
    
    <div class="mb-3">
      <input type="text" class="form-control" id="search-offers" placeholder="Search by ID number or name...">
    </div>
    
    <div id="offers-list">
      <!-- Offers will be populated here -->
    </div>
    
    <div class="text-center mt-3">
      <button type="button" class="btn btn-secondary" onclick="closeOpenOffersModal()">Close</button>
    </div>
  </div>
</div>

<!-- COMPLETED OFFERS MODAL -->
<div id="completed-offers-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); z-index: 10000;">
  <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 10px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4>‚úÖ Completed Offers</h4>
      <button type="button" class="btn-close" onclick="closeCompletedOffersModal()"></button>
    </div>
    
    <div class="mb-3">
      <input type="text" class="form-control" id="search-completed-offers" placeholder="Search by ID number or name...">
    </div>
    
    <div id="completed-offers-list">
      <!-- Completed offers will be populated here -->
    </div>
    
    <div class="text-center mt-3">
      <button type="button" class="btn btn-secondary" onclick="closeCompletedOffersModal()">Close</button>
    </div>
  </div>
</div>

<!-- MAIN FORM -->
<div id="main-form" style="display: none;">
    <!-- Colored Header Band -->
    <div class="header-band">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-4 text-start">
          <a href="/dashboard" class="btn btn-outline-light btn-sm" style="border-radius: 20px; padding: 8px 16px; margin-right: 10px;">
            ‚Üê Back to Dashboard
          </a>
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-light btn-sm" id="open-offers-btn" style="border-radius: 20px 0 0 20px; padding: 8px 16px;">
              üìÅ Open Offers
            </button>
            <button type="button" class="btn btn-outline-light btn-sm" id="completed-offers-btn" style="border-radius: 0; padding: 8px 16px; border-left: none;">
              ‚úÖ Completed
            </button>
            <button type="button" class="btn btn-outline-light btn-sm" id="new-offer-btn" style="border-radius: 0 20px 20px 0; padding: 8px 16px; border-left: none;">
              ‚ûï New
            </button>
          </div>
        </div>
        <div class="col-md-4 text-center">
          <img src="/static/images/gosmarthr-logo.png" alt="SmartHR">
    <h2>The Negotiator ‚Äì Basic Salary Mode</h2>
          <div id="welcome-message" style="display: none; color: #fff; font-size: 1.1rem; margin-top: 0.5rem; font-weight: 500;">
            Welcome, <span id="welcome-name"></span>!
          </div>
        </div>
        <div class="col-md-4">
          <!-- Empty column for balance -->
        </div>
      </div>
    </div>
  </div>

  <div class="container mb-4">
  <!-- Personal Details -->
  <div class="tile-section">
      <div class="section-header">
        <img src="/static/images/personal-icon.png" alt="Personal">
        Personal Details
        <span class="age-display" id="age-display" style="display: none; margin-left: auto;">Age: <span id="calculated-age"></span></span>
      </div>
      <div class="row g-2 mt-1">
        <div class="col-md-3"><input type="text" class="form-control" id="first_name" placeholder="First Name"></div>
        <div class="col-md-3"><input type="text" class="form-control" id="surname" placeholder="Surname"></div>
        <div class="col-md-3"><input type="text" class="form-control" id="id_number" placeholder="ID Number"></div>
        <div class="col-md-3"><input type="email" class="form-control" id="email" placeholder="Email"></div>
      <div class="col-md-4"><input type="text" class="form-control" id="job_title" placeholder="Job Title"></div>
      <div class="col-md-4"><input type="text" class="form-control" id="department" placeholder="Department"></div>
        <div class="col-md-4">
          <input type="date" class="form-control" id="start_date" placeholder="Start Date">
          <small class="form-text text-muted">Anticipated start date</small>
        </div>
    </div>
  </div>

  <div class="row">
    <!-- Earnings and Employer -->
    <div class="col-md-6">
      <div class="tile-section">
          <div class="section-header">
            <img src="/static/images/income-icon.png" alt="Earnings">
            Earnings
          </div>
          <div class="mb-3 p-3 border rounded bg-light">
            <label for="basic_salary" class="form-label fw-bold text-primary">Basic Salary:</label>
            <input type="number" class="form-control form-control-lg" id="basic_salary" placeholder="Enter basic salary amount" step="0.01" min="0">
            <div class="mt-2 text-muted">
              <small>Current Value: R <span id="basic-salary-display" class="fw-bold">0.00</span></small>
            </div>
          </div>
          
          <!-- Pensionable Salary Section -->
          <div class="pension-toggle">
            <span>Pensionable Salary:</span>
            <input type="number" class="form-control" id="pensionable_percent" placeholder="100" style="max-width: 80px;">
            <span style="margin-left: 5px; font-weight: bold;">%</span>
          </div>
          
          <div class="pension-calc" id="pension-calc">
            Calculated Amount: R <span id="pension-calc-amount">0.00</span>
          </div>
          
        <div id="earnings-list"></div>
          <div class="row g-2">
            <div class="col-8">
              <select id="earning-dropdown" class="form-select">
          <option value="">Select earning to add</option>
          <option value="Travel Allowance">Travel Allowance</option>
          <option value="Cellphone Allowance">Cellphone Allowance</option>
          <option value="Internet Allowance">Internet Allowance</option>
          <option value="Entertainment Allowance">Entertainment Allowance</option>
          <option value="Medical Allowance">Medical Allowance</option>
                <option value="Bonus">Bonus</option>
          <option value="Other">Other</option>
        </select>
        <small class="text-muted" style="font-size: 0.75rem; display: block; margin-top: 2px;">üí° Tip: "Other" items can be edited later by clicking the ‚úèÔ∏è button or the orange underlined text</small>
            </div>
            <div class="col-3">
              <input type="number" class="form-control" id="earning-value" placeholder="Amount" style="display: none;">
            </div>
            <div class="col-1">
              <button type="button" class="btn btn-success btn-sm" id="add-earning-btn" style="display: none; width: 100%; font-size: 0.8rem;">+</button>
            </div>
          </div>
          
          <!-- Running Total for Earnings -->
          <div class="running-total earnings">
            Total Earnings: R <span id="total-earnings">0.00</span>
          </div>
      </div>

      <div class="tile-section">
          <div class="section-header">
            <img src="/static/images/pension-icon.png" alt="Employer">
            Employer Contributions
          </div>
          <div class="mb-2 grey-box">UIF: R <span id="uif_er_val">0.00</span></div>
          <div class="mb-2">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="uif_to_ctc" checked>
              <label class="form-check-label" for="uif_to_ctc" style="font-size: 0.85em;">
                Include UIF in CTC calculation
              </label>
            </div>
          </div>
        <div class="mb-2 grey-box">SDL: R <span id="sdl_val">0.00</span></div>
        <div id="employer-list"></div>
          <div class="row g-2">
            <div class="col-8">
              <select id="employer-dropdown" class="form-select">
          <option value="">Select contribution</option>
                <option value="Pension/Provident/RA">Pension/Provident/RA</option>
                <option value="Medical Aid">Medical Aid</option>
          <option value="Other">Other</option>
        </select>
        <small class="text-muted" style="font-size: 0.75rem; display: block; margin-top: 2px;">üí° Tip: "Other" items can be edited later by clicking the ‚úèÔ∏è button or the orange underlined text</small>
            </div>
            <div class="col-4">
              <div class="row g-1" id="employer-toggle-container" style="display: none;">
                <div class="col-6">
                  <button type="button" class="btn btn-sm btn-outline-secondary employer-toggle" data-type="amount" style="width: 100%; font-size: 0.7rem;">R</button>
                </div>
                <div class="col-6">
                  <button type="button" class="btn btn-sm btn-outline-secondary employer-toggle" data-type="percentage" style="width: 100%; font-size: 0.7rem;">%</button>
                </div>
              </div>
              <input type="number" class="form-control mt-1" id="employer-value" placeholder="Amount" style="display: none;">
            </div>
          </div>
          
          <!-- Running Total for Employer -->
          <div class="running-total employer">
            Total Employer: R <span id="total-employer">0.00</span>
          </div>
      </div>
    </div>

    <!-- Deductions and Net Pay -->
    <div class="col-md-6">
      <div class="tile-section">
          <div class="section-header">
            <img src="/static/images/deductions-icon.png" alt="Deductions">
            Deductions
          </div>
        <div class="mb-2 grey-box">PAYE: R <span id="paye_val">0.00</span></div>
          <div class="mb-2 grey-box">UIF: R <span id="uif_ee_val">0.00</span></div>
        <div id="deduction-list"></div>
          <div class="row g-2">
            <div class="col-8">
              <select id="deduction-dropdown" class="form-select">
          <option value="">Select deduction</option>
                <option value="Pension/Provident/RA">Pension/Provident/RA</option>
                <option value="Medical Aid">Medical Aid</option>
          <option value="Union">Union</option>
          <option value="Personnel Club">Personnel Club</option>
          <option value="Other">Other</option>
        </select>
        <small class="text-muted" style="font-size: 0.75rem; display: block; margin-top: 2px;">üí° Tip: "Other" items can be edited later by clicking the ‚úèÔ∏è button or the orange underlined text</small>
            </div>
            <div class="col-3">
              <div class="row g-1" id="deduction-toggle-container" style="display: none;">
                <div class="col-6">
                  <button type="button" class="btn btn-sm btn-outline-secondary deduction-toggle" data-type="amount" style="width: 100%; font-size: 0.7rem;">R</button>
                </div>
                <div class="col-6">
                  <button type="button" class="btn btn-sm btn-outline-secondary deduction-toggle" data-type="percentage" style="width: 100%; font-size: 0.7rem;">%</button>
                </div>
              </div>
              <input type="number" class="form-control mt-1" id="deduction-value" placeholder="Amount" style="display: none;">
            </div>
            <div class="col-1">
              <button type="button" class="btn btn-success btn-sm" id="add-deduction-btn" style="display: none; width: 100%; font-size: 0.8rem;">+</button>
            </div>
          </div>
          
          <!-- Dependants field for Medical Aid -->
          <div class="dependants-field" id="dependants-field">
            <label for="dependants" class="form-label">Additional Dependants (excluding main member):</label>
            <input type="number" class="form-control" id="dependants" placeholder="0" min="0" max="10" style="max-width: 100px;">
          </div>
          
          <!-- Running Total for Deductions -->
          <div class="running-total deductions">
            Total Deductions: R <span id="total-deductions">0.00</span>
          </div>
      </div>

      <div class="tile-section">
          <div class="section-header">
            üíº Cost to Company
          </div>
          <div class="ctc-highlight">R <span id="ctc_total_val">0.00</span></div>
        </div>

        <div class="tile-section">
          <div class="section-header">
            üí∞ Net Pay
          </div>
        <div class="net-pay-highlight">R <span id="net_pay_val">0.00</span></div>
          
          <!-- Action Buttons -->
          <div class="row g-2 mt-3">
            <div class="col-4">
              <button type="button" class="btn btn-primary w-100" id="save-offer-btn">
                üíæ Save Offer
              </button>
      </div>
            <div class="col-4">
              <button type="button" class="btn btn-success w-100" id="print-offer-btn">
                üñ®Ô∏è Print Offer
              </button>
            </div>
            <div class="col-4">
              <button type="button" class="btn btn-warning w-100" id="complete-offer-btn">
                ‚úÖ Complete
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const popup = document.getElementById("popup");
    const popupForm = document.getElementById("popup-form");

    // Initialize dynamic lists
    let earningsCount = 0;
    let deductionsCount = 0;
    let employerCount = 0;

    if (sessionStorage.getItem("userID")) {
      popup.style.display = "none";
      document.getElementById("main-form").style.display = "block";
      const userId = sessionStorage.getItem("userID");
      // Don't set ID field - let user enter the person's ID number
      
      // Handle Admin test mode
      if (userId.toLowerCase() === 'admin') {
        document.getElementById('first_name').value = 'DUMMY';
        document.getElementById('surname').value = 'USER';
        document.getElementById('calculated-age').textContent = '35';
        document.getElementById('age-display').style.display = 'inline-block';
      } else {
        calculateAgeFromID(userId);
      }
      
      // Load saved offer if exists
      loadSavedOffer(userId);
    }

    popupForm.addEventListener("submit", function (e) {
      e.preventDefault();
      const id = document.getElementById("popup-id").value;
      if (id) {
        sessionStorage.setItem("userID", id);
        sessionStorage.setItem("calculatorMode", "basic"); // Default mode
        
        // Check if user has a saved offer
        const savedData = localStorage.getItem(`offer_${id}`);
        let userName = '';
        if (savedData) {
          try {
            const offerData = JSON.parse(savedData);
            const firstName = offerData.first_name || '';
            const surname = offerData.surname || '';
            userName = `${firstName} ${surname}`.trim() || id;
          } catch (e) {
            userName = id;
          }
        }
        
        // Stay on current page (basic mode)
        popup.style.display = "none";
        document.getElementById("main-form").style.display = "block";
        // Don't set ID field - let user enter the person's ID number
        
        // Show welcome message with current logged-in user
        const currentUser = sessionStorage.getItem('userID') || 'User';
        document.getElementById('welcome-name').textContent = currentUser;
        document.getElementById('welcome-message').style.display = 'block';
        
        // Handle Admin test mode
        if (id.toLowerCase() === 'admin') {
          document.getElementById('first_name').value = 'DUMMY';
          document.getElementById('surname').value = 'USER';
          document.getElementById('calculated-age').textContent = '35';
          document.getElementById('age-display').style.display = 'inline-block';
          document.getElementById('welcome-name').textContent = 'Admin';
          document.getElementById('welcome-message').style.display = 'block';
        } else {
          calculateAgeFromID(id);
        }
        
        // Load saved offer if exists
        loadSavedOffer(id);
      }
    });

    // Set default start date (30 days from now)
    const defaultStartDate = new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0];
    document.getElementById('start_date').value = defaultStartDate;
    
    // Welcome message is now static - always shows logged-in user
    
    // Update basic salary display and totals when value changes
    document.getElementById('basic_salary').addEventListener('input', function() {
      const value = parseFloat(this.value) || 0;
      console.log('Basic salary changed to:', value);
      document.getElementById('basic-salary-display').textContent = value.toFixed(2);
      updateTotals();
    });
    
    // Also update when the page loads
    document.addEventListener('DOMContentLoaded', function() {
      const basicSalaryInput = document.getElementById('basic_salary');
      if (basicSalaryInput) {
        const value = parseFloat(basicSalaryInput.value) || 0;
        document.getElementById('basic-salary-display').textContent = value.toFixed(2);
      }
    });
    
    // ID Number age calculation only
    document.getElementById('id_number').addEventListener('input', function() {
      if (this.value.length >= 6) {
        calculateAgeFromID(this.value);
      }
    });


    
    function calculateAgeFromID(idNumber) {
      if (idNumber.length >= 6) {
        const year = parseInt(idNumber.substring(0, 2));
        const month = parseInt(idNumber.substring(2, 4));
        const day = parseInt(idNumber.substring(4, 6));
        
        // Determine century (assuming 1900s for years 00-29, 2000s for 30-99)
        const fullYear = year <= 29 ? 2000 + year : 1900 + year;
        
        const birthDate = new Date(fullYear, month - 1, day);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        
        // Adjust age if birthday hasn't occurred this year
        if (today.getMonth() < birthDate.getMonth() || 
            (today.getMonth() === birthDate.getMonth() && today.getDate() < birthDate.getDate())) {
          age--;
        }
        
        document.getElementById('calculated-age').textContent = age;
        document.getElementById('age-display').style.display = 'inline-block';
      }
    }

    // Pension calculation - always percentage
    document.getElementById('pensionable_percent').addEventListener('input', function() {
      updatePensionCalculation();
    });

    document.getElementById('basic_salary').addEventListener('input', function() {
      updatePensionCalculation();
    });

    // Pension calculation
    document.getElementById('pensionable_percent').addEventListener('input', function() {
      updatePensionCalculation();
    });

    document.getElementById('basic_salary').addEventListener('input', function() {
      updatePensionCalculation();
    });

    function updatePensionCalculation() {
      const basicSalary = parseFloat(document.getElementById('basic_salary').value) || 0;
      const percentage = parseFloat(document.getElementById('pensionable_percent').value) || 100;
      
      if (basicSalary > 0) {
        const calculatedAmount = (basicSalary * percentage) / 100;
        document.getElementById('pension-calc-amount').textContent = calculatedAmount.toFixed(2);
        document.getElementById('pension-calc').style.display = 'block';
      }
    }

    // Earnings dropdown functionality
    document.getElementById('earning-dropdown').addEventListener('change', function() {
      const value = this.value;
      const valueInput = document.getElementById('earning-value');
      const addBtn = document.getElementById('add-earning-btn');
      
      // Remove existing description input if any
      const existingDesc = document.getElementById('earning-description');
      if (existingDesc) {
        existingDesc.remove();
      }
      
      if (value) {
        valueInput.style.display = 'block';
        addBtn.style.display = 'block';
        valueInput.placeholder = value === 'Other' ? 'Enter amount' : 'Amount';
        
        // Add description input for "Other"
        if (value === 'Other') {
          // Create a container for inline inputs
          const inputContainer = document.createElement('div');
          inputContainer.style.cssText = 'display: flex; align-items: center; gap: 5px;';
          
          // Move the value input into the container
          valueInput.parentElement.insertBefore(inputContainer, valueInput);
          inputContainer.appendChild(valueInput);
          
          // Create and add description input
          const descriptionInput = document.createElement('input');
          descriptionInput.type = 'text';
          descriptionInput.id = 'earning-description';
          descriptionInput.className = 'form-control';
          descriptionInput.style.cssText = 'max-width: 120px;';
          descriptionInput.placeholder = 'Enter description';
          inputContainer.appendChild(descriptionInput);
        }
        
        valueInput.focus();
      } else {
        valueInput.style.display = 'none';
        addBtn.style.display = 'none';
        valueInput.value = '';
        
        // Remove description input and restore original layout if "Other" was selected
        const descriptionInput = document.getElementById('earning-description');
        if (descriptionInput) {
          const inputContainer = descriptionInput.parentElement;
          if (inputContainer && inputContainer.style.display === 'flex') {
            // Move value input back to original parent
            const originalParent = inputContainer.parentElement;
            originalParent.insertBefore(valueInput, inputContainer);
            inputContainer.remove();
          }
        }
      }
    });

    // Add earning when value is entered
    document.getElementById('earning-value').addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && this.value) {
        addEarning();
      }
    });

    // Add earning when + button is clicked
    document.getElementById('add-earning-btn').addEventListener('click', function() {
      if (document.getElementById('earning-value').value && document.getElementById('earning-dropdown').value) {
        addEarning();
      }
    });

    // Employer dropdown functionality
    document.getElementById('employer-dropdown').addEventListener('change', function() {
      const value = this.value;
      const valueInput = document.getElementById('employer-value');
      const toggleContainer = document.getElementById('employer-toggle-container');
      
      // Remove existing description input if any
      const existingDesc = document.getElementById('employer-description');
      if (existingDesc) {
        existingDesc.remove();
      }
      
      if (value) {
        valueInput.style.display = 'block';
        
        // Show percentage toggle only for Pension/Provident/RA
        if (value === 'Pension/Provident/RA') {
          toggleContainer.style.display = 'block';
        } else {
          toggleContainer.style.display = 'none';
        }
        
        valueInput.placeholder = value === 'Other' ? 'Enter amount' : 'Amount';
        
        // Add description input for "Other"
        if (value === 'Other') {
          // Create a container for inline inputs
          const inputContainer = document.createElement('div');
          inputContainer.style.cssText = 'display: flex; align-items: center; gap: 5px;';
          
          // Move the value input into the container
          valueInput.parentElement.insertBefore(inputContainer, valueInput);
          inputContainer.appendChild(valueInput);
          
          // Create and add description input
          const descriptionInput = document.createElement('input');
          descriptionInput.type = 'text';
          descriptionInput.id = 'employer-description';
          descriptionInput.className = 'form-control';
          descriptionInput.style.cssText = 'max-width: 120px;';
          descriptionInput.placeholder = 'Enter description';
          inputContainer.appendChild(descriptionInput);
        }
        
        valueInput.focus();
      } else {
        valueInput.style.display = 'none';
        valueInput.value = '';
        toggleContainer.style.display = 'none';
        
        // Remove description input and restore original layout if "Other" was selected
        const descriptionInput = document.getElementById('employer-description');
        if (descriptionInput) {
          const inputContainer = descriptionInput.parentElement;
          if (inputContainer && inputContainer.style.display === 'flex') {
            // Move value input back to original parent
            const originalParent = inputContainer.parentElement;
            originalParent.insertBefore(valueInput, inputContainer);
            inputContainer.remove();
          }
        }
      }
    });

    // Add employer contribution when value is entered
    document.getElementById('employer-value').addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && this.value) {
        addEmployer();
      }
    });

    // Deduction toggle functionality
    document.querySelectorAll('.deduction-toggle').forEach(btn => {
      btn.addEventListener('click', function() {
        const type = this.dataset.type;
        const container = document.getElementById('deduction-toggle-container');
        
        // Update active button
        container.querySelectorAll('.deduction-toggle').forEach(b => {
          b.classList.remove('btn-primary');
          b.classList.add('btn-outline-secondary');
        });
        this.classList.remove('btn-outline-secondary');
        this.classList.add('btn-primary');
        
        // Update input placeholder
        const input = document.getElementById('deduction-value');
        if (type === 'percentage') {
          input.placeholder = 'Percentage';
          input.setAttribute('max', '100');
        } else {
          input.placeholder = 'Amount';
          input.removeAttribute('max');
        }
      });
    });

    // Employer toggle functionality
    document.querySelectorAll('.employer-toggle').forEach(btn => {
      btn.addEventListener('click', function() {
        const type = this.dataset.type;
        const container = document.getElementById('employer-toggle-container');
        
        // Update active button
        container.querySelectorAll('.employer-toggle').forEach(b => {
          b.classList.remove('btn-primary');
          b.classList.add('btn-outline-secondary');
        });
        this.classList.remove('btn-outline-secondary');
        this.classList.add('btn-primary');
        
        // Update input placeholder
        const input = document.getElementById('employer-value');
        if (type === 'percentage') {
          input.placeholder = 'Percentage';
          input.setAttribute('max', '100');
        } else {
          input.placeholder = 'Amount';
          input.removeAttribute('max');
        }
      });
    });

    // Deductions dropdown functionality
    document.getElementById('deduction-dropdown').addEventListener('change', function() {
      const value = this.value;
      const valueInput = document.getElementById('deduction-value');
      const addBtn = document.getElementById('add-deduction-btn');
      const dependantsField = document.getElementById('dependants-field');
      const toggleContainer = document.getElementById('deduction-toggle-container');
      
      // Remove existing description input if any
      const existingDesc = document.getElementById('deduction-description');
      if (existingDesc) {
        existingDesc.remove();
      }
      
      if (value) {
        valueInput.style.display = 'block';
        addBtn.style.display = 'block';
        
        // Show percentage toggle only for Pension/Provident/RA
        if (value === 'Pension/Provident/RA') {
          toggleContainer.style.display = 'block';
        } else {
          toggleContainer.style.display = 'none';
        }
        
        valueInput.placeholder = value === 'Other' ? 'Enter amount' : 'Amount';
        
        // Add description input for "Other"
        if (value === 'Other') {
          // Create a container for inline inputs
          const inputContainer = document.createElement('div');
          inputContainer.style.cssText = 'display: flex; align-items: center; gap: 5px;';
          
          // Move the value input into the container
          valueInput.parentElement.insertBefore(inputContainer, valueInput);
          inputContainer.appendChild(valueInput);
          
          // Create and add description input
          const descriptionInput = document.createElement('input');
          descriptionInput.type = 'text';
          descriptionInput.id = 'deduction-description';
          descriptionInput.className = 'form-control';
          descriptionInput.style.cssText = 'max-width: 120px;';
          descriptionInput.placeholder = 'Enter description';
          inputContainer.appendChild(descriptionInput);
        }
        
        valueInput.focus();
        
        // Show dependants field for Medical Aid
        if (value === 'Medical Aid') {
          dependantsField.style.display = 'block';
        } else {
          dependantsField.style.display = 'none';
        }
      } else {
        valueInput.style.display = 'none';
        addBtn.style.display = 'none';
        valueInput.value = '';
        dependantsField.style.display = 'none';
        toggleContainer.style.display = 'none';
        
        // Remove description input and restore original layout if "Other" was selected
        const descriptionInput = document.getElementById('deduction-description');
        if (descriptionInput) {
          const inputContainer = descriptionInput.parentElement;
          if (inputContainer && inputContainer.style.display === 'flex') {
            // Move value input back to original parent
            const originalParent = inputContainer.parentElement;
            originalParent.insertBefore(valueInput, inputContainer);
            inputContainer.remove();
          }
        }
      }
    });

    // Add deduction when value is entered
    document.getElementById('deduction-value').addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && this.value) {
        addDeduction();
      }
    });

    // Add deduction when value input loses focus (alternative way to add)
    document.getElementById('deduction-value').addEventListener('blur', function(e) {
      // Don't auto-add if user is clicking on dependants field
      if (this.value && document.getElementById('deduction-dropdown').value && 
          !e.relatedTarget || !e.relatedTarget || !e.relatedTarget.closest('#dependants-field')) {
        addDeduction();
      }
    });

    // Add deduction when + button is clicked
    document.getElementById('add-deduction-btn').addEventListener('click', function() {
      if (document.getElementById('deduction-value').value && document.getElementById('deduction-dropdown').value) {
        addDeduction();
      }
    });

    function addEarning() {
      const dropdown = document.getElementById('earning-dropdown');
      const valueInput = document.getElementById('earning-value');
      const addBtn = document.getElementById('add-earning-btn');
      const list = document.getElementById('earnings-list');
      const descriptionInput = document.getElementById('earning-description');
      
      if (dropdown.value && valueInput.value) {
        let displayName = dropdown.value;
        let displayText = `R ${parseFloat(valueInput.value).toFixed(2)}`;
        
        // Use description for "Other" items
        if (dropdown.value === 'Other' && descriptionInput && descriptionInput.value.trim()) {
          displayName = descriptionInput.value.trim();
        }
        
        const item = document.createElement('div');
        item.className = 'dynamic-item';
        const isOtherItem = dropdown.value === 'Other';
        item.innerHTML = `
          <div style="flex: 1; display: flex; align-items: center;">
            <span class="item-label" style="font-weight: bold; min-width: 120px; ${isOtherItem ? 'cursor: pointer; border-bottom: 2px dashed #f47c04; color: #f47c04;' : ''}" title="${isOtherItem ? 'Click to edit description' : ''}">${displayName}:</span>
            <span style="color: #666; font-size: 0.85em; margin-left: 10px;">${displayText.includes('%') ? displayText : ''}</span>
          </div>
          <div style="flex: 1; display: flex; align-items: center; justify-content: flex-end;">
            <span class="amount-display" style="font-weight: 500; margin-right: 10px;">${displayText.includes('%') ? '' : displayText}</span>
            <div class="edit-inputs-container" style="display: none; margin-right: 10px;">
              ${isOtherItem ? `<input type="text" class="form-control edit-description" value="${displayName}" style="display: inline-block; max-width: 120px; margin-right: 5px;" placeholder="Description">` : ''}
              <input type="number" class="form-control edit-input" value="${parseFloat(valueInput.value).toFixed(2)}" style="display: inline-block; max-width: 80px; margin-right: 5px;">
            </div>
            <button type="button" class="btn btn-xs btn-outline-primary edit-btn" onclick="editEarningItem(this);" style="margin-right: 3px; padding: 2px 6px; font-size: 0.75em;" title="Edit item">‚úèÔ∏è</button>
            <button type="button" class="remove-btn" onclick="removeEarningItem(this);" style="padding: 2px 6px; font-size: 0.75em;">√ó</button>
          </div>
        `;
        
        // Add click handler for "Other" item labels to make them editable
        if (isOtherItem) {
          const label = item.querySelector('.item-label');
          label.addEventListener('click', function() {
            editEarningItem(item.querySelector('.edit-btn'));
          });
        }
        list.appendChild(item);
        
        // Remove the option from dropdown (except for 'Other')
        if (dropdown.value !== 'Other') {
          const selectedOption = dropdown.querySelector(`option[value="${dropdown.value}"]`);
          if (selectedOption) {
            selectedOption.remove();
          }
        }
        
        // Reset inputs
        dropdown.value = '';
        valueInput.value = '';
        valueInput.style.display = 'none';
        addBtn.style.display = 'none';
        if (descriptionInput) {
          descriptionInput.remove();
        }
        
        updateTotals();
      }
    }





    function addEmployer() {
      const dropdown = document.getElementById('employer-dropdown');
      const valueInput = document.getElementById('employer-value');
      const list = document.getElementById('employer-list');
      const descriptionInput = document.getElementById('employer-description');
      
      if (dropdown.value && valueInput.value) {
        let amount = parseFloat(valueInput.value);
        let displayText = `R ${amount.toFixed(2)}`;
        let displayName = dropdown.value;
        
        // Use description for "Other" items
        if (dropdown.value === 'Other' && descriptionInput && descriptionInput.value.trim()) {
          displayName = descriptionInput.value.trim();
        }
        
        // Calculate percentage for Pension/Provident/RA
        if (dropdown.value === 'Pension/Provident/RA') {
          const activeToggle = document.querySelector('.employer-toggle.btn-primary');
          if (activeToggle && activeToggle.dataset.type === 'percentage') {
            const basicSalary = parseFloat(document.getElementById('basic_salary').value) || 0;
            const pensionablePercent = parseFloat(document.getElementById('pensionable_percent').value) || 100;
            const pensionableSalary = (basicSalary * pensionablePercent) / 100;
            amount = (pensionableSalary * amount) / 100;
            displayText = `${valueInput.value}% = R ${amount.toFixed(2)}`;
          }
        }
        
        const item = document.createElement('div');
        item.className = 'dynamic-item';
        const isOtherItem = dropdown.value === 'Other';
        item.innerHTML = `
          <div style="flex: 1; display: flex; align-items: center;">
            <span class="item-label" style="font-weight: bold; min-width: 120px; ${isOtherItem ? 'cursor: pointer; border-bottom: 2px dashed #f47c04; color: #f47c04;' : ''}" title="${isOtherItem ? 'Click to edit description' : ''}">${displayName}:</span>
            <span style="color: #666; font-size: 0.85em; margin-left: 10px; flex: 1;">${displayText.includes('%') ? displayText.split(' = ')[0] : ''}</span>
          </div>
          <div style="flex: 1; display: flex; align-items: center; justify-content: flex-end;">
            <span class="amount-display" style="font-weight: 500; margin-right: 10px;">${displayText.includes('%') ? 'R ' + displayText.split('= R ')[1] : displayText}</span>
            <div class="edit-inputs-container" style="display: none; margin-right: 10px;">
              ${isOtherItem ? `<input type="text" class="form-control edit-description" value="${displayName}" style="display: inline-block; max-width: 120px; margin-right: 5px;" placeholder="Description">` : ''}
              <input type="number" class="form-control edit-input" value="${amount.toFixed(2)}" style="display: inline-block; max-width: 80px; margin-right: 5px;">
            </div>
            <button type="button" class="btn btn-xs btn-outline-primary edit-btn" onclick="editEmployerItem(this);" style="margin-right: 3px; padding: 2px 6px; font-size: 0.75em;" title="Edit item">‚úèÔ∏è</button>
            <button type="button" class="remove-btn" onclick="removeEmployerItem(this);" style="padding: 2px 6px; font-size: 0.75em;">√ó</button>
          </div>
        `;
        
        // Add click handler for "Other" item labels to make them editable
        if (isOtherItem) {
          const label = item.querySelector('.item-label');
          label.addEventListener('click', function() {
            editEmployerItem(item.querySelector('.edit-btn'));
          });
        }
        list.appendChild(item);
        
        // Remove the option from dropdown (except for 'Other')
        if (dropdown.value !== 'Other') {
          const selectedOption = dropdown.querySelector(`option[value="${dropdown.value}"]`);
          if (selectedOption) {
            selectedOption.remove();
          }
        }
        
        // Reset inputs
        dropdown.value = '';
        valueInput.value = '';
        valueInput.style.display = 'none';
        if (descriptionInput) {
          descriptionInput.remove();
        }
        
        updateTotals();
      }
    }



    function addDeduction() {
      const dropdown = document.getElementById('deduction-dropdown');
      const valueInput = document.getElementById('deduction-value');
      const addBtn = document.getElementById('add-deduction-btn');
      const list = document.getElementById('deduction-list');
      const dependantsField = document.getElementById('dependants-field');
      const dependantsInput = document.getElementById('dependants');
      const descriptionInput = document.getElementById('deduction-description');
      
      if (dropdown.value && valueInput.value) {
        let amount = parseFloat(valueInput.value);
        let displayText = `R ${amount.toFixed(2)}`;
        let dependants = 0;
        let displayName = dropdown.value;
        
        // Use description for "Other" items
        if (dropdown.value === 'Other' && descriptionInput && descriptionInput.value.trim()) {
          displayName = descriptionInput.value.trim();
        }
        
        // Get dependants if Medical Aid
        if (dropdown.value === 'Medical Aid' && dependantsField.style.display !== 'none') {
          dependants = parseInt(dependantsInput.value) || 0;
        }
        
        // Calculate percentage for Pension/Provident/RA
        if (dropdown.value === 'Pension/Provident/RA') {
          const activeToggle = document.querySelector('.deduction-toggle.btn-primary');
          if (activeToggle && activeToggle.dataset.type === 'percentage') {
            const basicSalary = parseFloat(document.getElementById('basic_salary').value) || 0;
            const pensionablePercent = parseFloat(document.getElementById('pensionable_percent').value) || 100;
            const pensionableSalary = (basicSalary * pensionablePercent) / 100;
            amount = (pensionableSalary * amount) / 100;
            displayText = `${valueInput.value}% = R ${amount.toFixed(2)}`;
          }
        }
        
        const item = document.createElement('div');
        item.className = 'dynamic-item';
        const isOtherItem = dropdown.value === 'Other';
        item.innerHTML = `
          <div style="flex: 1; display: flex; align-items: center;">
            <span class="item-label" style="font-weight: bold; min-width: 120px; ${isOtherItem ? 'cursor: pointer; border-bottom: 2px dashed #f47c04; color: #f47c04;' : ''}" title="${isOtherItem ? 'Click to edit description' : ''}">${displayName}:</span>
            <span style="color: #666; font-size: 0.85em; margin-left: 10px; flex: 1;">${displayText.includes('%') ? displayText.split(' = ')[0] : ''}${dependants > 0 ? ` (${dependants} dependants)` : ''}</span>
          </div>
          <div style="flex: 1; display: flex; align-items: center; justify-content: flex-end;">
            <span class="amount-display" style="font-weight: 500; margin-right: 10px;">${displayText.includes('%') ? 'R ' + displayText.split('= R ')[1] : displayText}</span>
            <div class="edit-inputs-container" style="display: none; margin-right: 10px;">
              ${isOtherItem ? `<input type="text" class="form-control edit-description" value="${displayName}" style="display: inline-block; max-width: 120px; margin-right: 5px;" placeholder="Description">` : ''}
              <input type="number" class="form-control edit-input" value="${amount.toFixed(2)}" style="display: inline-block; max-width: 80px; margin-right: 5px;">
            </div>
            <input type="number" class="form-control edit-dependants" value="${dependants}" style="display: none; max-width: 60px; margin-right: 5px;" placeholder="Dependants">
            <button type="button" class="btn btn-xs btn-outline-primary edit-btn" onclick="editDeductionItem(this);" style="margin-right: 3px; padding: 2px 6px; font-size: 0.75em;" title="Edit item">‚úèÔ∏è</button>
            <button type="button" class="remove-btn" onclick="removeDeductionItem(this);" style="padding: 2px 6px; font-size: 0.75em;">√ó</button>
          </div>
        `;
        
        // Add click handler for "Other" item labels to make them editable
        if (isOtherItem) {
          const label = item.querySelector('.item-label');
          label.addEventListener('click', function() {
            editDeductionItem(item.querySelector('.edit-btn'));
          });
        }
        list.appendChild(item);
        
        // Remove the option from dropdown (except for 'Other')
        if (dropdown.value !== 'Other') {
          const selectedOption = dropdown.querySelector(`option[value="${dropdown.value}"]`);
          if (selectedOption) {
            selectedOption.remove();
          }
        }
        
        // Reset inputs
        dropdown.value = '';
        valueInput.value = '';
        valueInput.style.display = 'none';
        addBtn.style.display = 'none';
        dependantsField.style.display = 'none';
        dependantsInput.value = '';
        if (descriptionInput) {
          descriptionInput.remove();
        }
        
        updateTotals();
      }
    }



    function updateTotals() {
      // Get tax settings from admin dashboard
      const taxSettings = JSON.parse(localStorage.getItem('taxSettings') || '{}');
      
      // Calculate total earnings (excluding travel allowance for tax purposes)
      const basicSalary = parseFloat(document.getElementById('basic_salary').value) || 0;
      console.log('Basic salary in updateTotals:', basicSalary);
      const earnings = document.querySelectorAll('#earnings-list .dynamic-item');
      let totalEarnings = basicSalary;
      let travelAllowanceAmount = 0;
      
      earnings.forEach(item => {
        const amountDisplay = item.querySelector('.amount-display');
        if (amountDisplay) {
          const amount = parseFloat(amountDisplay.textContent.replace('R ', '')) || 0;
          const itemName = item.querySelector('.item-label').textContent;
          
          // Separate travel allowance for tax calculation
          if (itemName.includes('Transport Allowance') || itemName.includes('Travel Allowance')) {
            travelAllowanceAmount = amount;
          } else {
            totalEarnings += amount;
          }
        }
      });
      
      // Display total earnings including travel allowance for UI purposes
      const displayTotalEarnings = totalEarnings + travelAllowanceAmount;
      document.getElementById('total-earnings').textContent = displayTotalEarnings.toFixed(2);
      
      // Calculate UIF (Employee and Employer) - SARS compliant
      const uifCap = parseFloat(taxSettings.uif_ceiling) || 17712; // Monthly UIF cap from admin dashboard
      const uifRate = 0.01; // 1% rate
      
      // UIF calculation based on gross salary (capped) - includes travel allowance
      const grossSalary = displayTotalEarnings; // Include travel allowance for UIF
      const uifBase = Math.min(grossSalary, uifCap);
      const uifEE = uifBase * uifRate; // Employee contribution
      const uifER = uifBase * uifRate; // Employer contribution
      
      // Update UIF displays
      document.getElementById('uif_ee_val').textContent = uifEE.toFixed(2);
      document.getElementById('uif_er_val').textContent = uifER.toFixed(2);
      
      // Calculate SDL (Skills Development Levy)
      const sdlRate = 0.01; // 1% rate
      
      // SDL calculation based on total remuneration (uncapped)
      // Total remuneration = Basic salary + Earnings + Employer contributions
      const employerContributions = document.querySelectorAll('#employer-list .dynamic-item');
      let totalEmployerContributions = 0;
      
      employerContributions.forEach(item => {
        const amountDisplay = item.querySelector('.amount-display');
        if (amountDisplay) {
          const text = amountDisplay.textContent;
          let amount = 0;
          
          // Handle percentage display text
          if (text.includes('=')) {
            amount = parseFloat(text.split('= R ')[1]) || 0;
          } else {
            amount = parseFloat(text.replace('R ', '')) || 0;
          }
          
          totalEmployerContributions += amount;
        }
      });
      
      const totalRemuneration = displayTotalEarnings + totalEmployerContributions;
      const sdl = totalRemuneration * sdlRate;
      
      // Update SDL display
      document.getElementById('sdl_val').textContent = sdl.toFixed(2);
      
      // Calculate PAYE using SARS-compliant method
      const monthlySalary = totalEarnings; // Excludes travel allowance
      const annualIncome = monthlySalary * 12;
      
      // Calculate travel allowance (80% taxable)
      const annualTravelTaxable = travelAllowanceAmount * 12 * 0.8;
      
      let taxableIncome = annualIncome + annualTravelTaxable;
      

      

      
      // Calculate pension deductions
      const pensionablePercent = parseFloat(document.getElementById('pensionable_percent').value) || 100;
      const pensionableIncome = monthlySalary * (pensionablePercent / 100);
      
      // Get employee pension contribution
      const employeePensionItem = Array.from(document.querySelectorAll('#deduction-list .dynamic-item')).find(item =>
        item.querySelector('.item-label').textContent.includes('Pension/Provident/RA')
      );
      let pensionEmployee = 0;
      if (employeePensionItem) {
        const pensionText = employeePensionItem.querySelector('.amount-display').textContent;
        if (pensionText.includes('=')) {
          pensionEmployee = parseFloat(pensionText.split('= R ')[1]) || 0;
        } else {
          pensionEmployee = parseFloat(pensionText.replace('R ', '')) || 0;
        }
      }
      
      // Get employer pension contribution
      const employerPensionItem = Array.from(employerContributions).find(item =>
        item.querySelector('.item-label').textContent.includes('Pension/Provident/RA')
      );
      let pensionEmployer = 0;
      if (employerPensionItem) {
        const pensionText = employerPensionItem.querySelector('.amount-display').textContent;
        if (pensionText.includes('=')) {
          pensionEmployer = parseFloat(pensionText.split('= R ')[1]) || 0;
        } else {
          pensionEmployer = parseFloat(pensionText.replace('R ', '')) || 0;
        }
      }
      
      // Calculate total pension deductible (capped at 27.5% of taxable income or R350,000)
      const annualPensionEmployee = pensionEmployee * 12;
      const annualPensionEmployer = pensionEmployer * 12;
      let totalPensionDeductible = annualPensionEmployee + annualPensionEmployer;
      totalPensionDeductible = Math.min(totalPensionDeductible, 0.275 * taxableIncome, 350000);
      
      taxableIncome -= totalPensionDeductible;
      
      // Calculate tax using admin dashboard brackets
      function calculateTax(income) {
        const taxBrackets = JSON.parse(localStorage.getItem('taxBrackets') || '[]');
        console.log('Raw tax brackets from localStorage:', JSON.stringify(taxBrackets, null, 2));
        
        if (taxBrackets.length === 0) {
          // Fallback to default SARS brackets if none configured
          const defaultBrackets = [
            [0, 237100, 0.18, 0],
            [237101, 370500, 0.26, 42678],
            [370501, 512800, 0.31, 77362],
            [512801, 673000, 0.36, 121475],
            [673001, 857900, 0.39, 179147],
            [857901, 1817000, 0.41, 251258],
            [1817001, Infinity, 0.45, 644489]
          ];
          
          for (const [lower, upper, rate, base] of defaultBrackets) {
            if (income <= upper) {
              return base + (income - lower) * rate;
            }
          }
          return 0;
        }
        
        // Use admin dashboard brackets with base amounts
        const brackets = [];
        
        for (let i = 0; i < taxBrackets.length; i++) {
          const bracket = taxBrackets[i];
          const lowEnd = bracket.lowEnd || 0;
          const highEnd = bracket.highEnd || bracket.threshold || 0;
          const rate = bracket.rate / 100;
          const baseAmount = bracket.baseAmount || 0;
          
          // Add bracket with proper range
          brackets.push([lowEnd, highEnd, rate, baseAmount]);
        }
        
        // Use SARS calculation method
        console.log('Tax brackets:', brackets);
        for (const [lower, upper, rate, base] of brackets) {
          console.log(`Checking bracket: ${lower} to ${upper}, rate: ${rate}, base: ${base}`);
          if (income <= upper) {
            const tax = base + (income - lower) * rate;
            console.log(`Tax calculated: ${base} + (${income} - ${lower}) * ${rate} = ${tax}`);
            return tax;
          }
        }
        
        return 0;
      }
      
      let annualTax = calculateTax(taxableIncome);
      
      // Debug tax calculation
      console.log('=== TAX CALCULATION DEBUG ===');
      console.log('Taxable Income (annual):', taxableIncome);
      console.log('Tax before rebates:', annualTax);
      
      // Apply rebates from admin dashboard
      const age = parseInt(document.getElementById('calculated-age').textContent) || 0;
      const primaryRebate = parseFloat(taxSettings.rebate_primary) || 17235;
      const secondaryRebate = parseFloat(taxSettings.rebate_secondary) || 9444;
      const tertiaryRebate = parseFloat(taxSettings.rebate_tertiary) || 3145;
      
      let rebate = primaryRebate; // Primary rebate
      if (age >= 65) {
        rebate += secondaryRebate; // Secondary rebate
      }
      if (age >= 75) {
        rebate += tertiaryRebate; // Tertiary rebate
      }
      annualTax -= rebate;
      annualTax = Math.max(0, annualTax);
      
      console.log('Age:', age);
      console.log('Rebate applied:', rebate);
      console.log('Tax after rebates:', annualTax);
      
      // Apply medical tax credits
      const medicalAidItem = Array.from(document.querySelectorAll('#deduction-list .dynamic-item')).find(item =>
        item.querySelector('.item-label').textContent.includes('Medical Aid')
      );
      if (medicalAidItem) {
        // Try multiple ways to find dependants count
        let dependants = 0;
        
        // Method 1: Look for .dependants-display element
        const dependantsDisplay = medicalAidItem.querySelector('.dependants-display');
        console.log('Dependants display element:', dependantsDisplay);
        
        if (dependantsDisplay) {
          console.log('Dependants display text:', dependantsDisplay.textContent);
          dependants = parseInt(dependantsDisplay.textContent.match(/\d+/)[0]) || 0;
        } else {
          // Method 2: Look for dependants in the text content
          const itemText = medicalAidItem.textContent;
          console.log('Medical aid item text:', itemText);
          
          // Look for pattern like "(2 dependants)" in the text
          const dependantsMatch = itemText.match(/\((\d+)\s*dependants?\)/i);
          if (dependantsMatch) {
            dependants = parseInt(dependantsMatch[1]) || 0;
            console.log('Found dependants in text:', dependants);
          } else {
            // Method 3: Look for edit-dependants input value
            const dependantsInput = medicalAidItem.querySelector('.edit-dependants');
            if (dependantsInput) {
              dependants = parseInt(dependantsInput.value) || 0;
              console.log('Found dependants in input:', dependants);
            }
          }
        }
        
        console.log('Final parsed dependants count:', dependants);
        
        // Get MTC values from admin settings (stored in localStorage)
        const mainMemberMTC = parseFloat(taxSettings.medical_main) || 364;
        const firstDependantMTC = parseFloat(taxSettings.medical_first) || 364;
        const additionalDependantMTC = parseFloat(taxSettings.medical_additional) || 246;
        
        let monthlyMedicalCredit = mainMemberMTC; // Main member
        console.log('MTC Breakdown:');
        console.log('- Main member MTC:', mainMemberMTC);
        
        if (dependants >= 1) {
          monthlyMedicalCredit += firstDependantMTC; // First dependant
          console.log('- First dependant MTC:', firstDependantMTC);
          
          if (dependants > 1) {
            const additionalDependants = dependants - 1;
            const additionalMTC = additionalDependants * additionalDependantMTC;
            monthlyMedicalCredit += additionalMTC; // Additional dependants
            console.log('- Additional dependants:', additionalDependants);
            console.log('- Additional dependants MTC:', additionalMTC);
          }
        }
        
        annualTax -= monthlyMedicalCredit * 12;
        console.log('Medical dependants:', dependants);
        console.log('Monthly MTC:', monthlyMedicalCredit);
        console.log('Annual MTC:', monthlyMedicalCredit * 12);
        console.log('Tax after MTC:', annualTax);
      }
      
      annualTax = Math.max(0, annualTax);
      const monthlyTax = Math.round(annualTax / 12 * 100) / 100;
      
      console.log('Final annual tax:', annualTax);
      console.log('Monthly tax:', monthlyTax);
      console.log('========================');
      
      // Update PAYE display
      document.getElementById('paye_val').textContent = monthlyTax.toFixed(2);
      
      // Calculate total deductions (including UIF EE and PAYE)
      const deductions = document.querySelectorAll('#deduction-list .dynamic-item');
      let totalDeductions = uifEE + monthlyTax; // Start with UIF EE and PAYE
      
      deductions.forEach(item => {
        const amountDisplay = item.querySelector('.amount-display');
        if (amountDisplay) {
          const text = amountDisplay.textContent;
          let amount = 0;
          
          // Handle percentage display text
          if (text.includes('=')) {
            amount = parseFloat(text.split('= R ')[1]) || 0;
          } else {
            amount = parseFloat(text.replace('R ', '')) || 0;
          }
          
          totalDeductions += amount;
        }
      });
      
      document.getElementById('total-deductions').textContent = totalDeductions.toFixed(2);
      
      // Calculate total employer (including UIF ER and SDL)
      const employer = document.querySelectorAll('#employer-list .dynamic-item');
      let totalEmployer = uifER + sdl; // Start with UIF ER and SDL
      
      employer.forEach(item => {
        const amountDisplay = item.querySelector('.amount-display');
        if (amountDisplay) {
          const text = amountDisplay.textContent;
          let amount = 0;
          
          // Handle percentage display text
          if (text.includes('=')) {
            amount = parseFloat(text.split('= R ')[1]) || 0;
          } else {
            amount = parseFloat(text.replace('R ', '')) || 0;
          }
          
          totalEmployer += amount;
        }
      });
      
      document.getElementById('total-employer').textContent = totalEmployer.toFixed(2);
      
      // Calculate net pay (should use total earnings including travel allowance)
      const netPay = displayTotalEarnings - totalDeductions;
      document.getElementById('net_pay_val').textContent = netPay.toFixed(2);
      
      // Calculate CTC (Cost to Company)
      const includeUIF = document.getElementById('uif_to_ctc').checked;
      let ctc = displayTotalEarnings + totalEmployer - sdl;
      if (!includeUIF) {
        ctc -= uifER;
      }
      document.getElementById('ctc_total_val').textContent = ctc.toFixed(2);
    }

    // Update totals when pensionable percentage changes (affects UIF calculation)
    document.getElementById('pensionable_percent').addEventListener('input', updateTotals);
    
    // Update CTC when UIF checkbox changes
    document.getElementById('uif_to_ctc').addEventListener('change', updateTotals);
    
    // Save Offer functionality
    document.getElementById('save-offer-btn').addEventListener('click', function() {
      saveOffer();
    });
    
    // Print Offer functionality
    document.getElementById('print-offer-btn').addEventListener('click', function() {
      printOffer();
    });
    
    // New Offer functionality
    document.getElementById('new-offer-btn').addEventListener('click', function() {
      showNewOfferPopup();
    });
    
    // Open Offers functionality
    document.getElementById('open-offers-btn').addEventListener('click', function() {
      showOpenOffersModal();
    });
    
    // Completed Offers functionality
    document.getElementById('completed-offers-btn').addEventListener('click', function() {
      showCompletedOffersModal();
    });
    
    // Complete Offer functionality
    document.getElementById('complete-offer-btn').addEventListener('click', function() {
      completeOffer();
    });
    
    // Search offers functionality
    document.getElementById('search-offers').addEventListener('input', function() {
      filterOffers(this.value);
    });
    
    // Search completed offers functionality
    document.getElementById('search-completed-offers').addEventListener('input', function() {
      filterCompletedOffers(this.value);
    });
    
    // Save offer data to localStorage
    function saveOffer() {
      const offerData = {
        // Personal details
        first_name: document.getElementById('first_name').value,
        surname: document.getElementById('surname').value,
        id_number: document.getElementById('id_number').value,
        email: document.getElementById('email').value,
        job_title: document.getElementById('job_title').value,
        department: document.getElementById('department').value,
        start_date: document.getElementById('start_date').value,
        
        // Basic salary and pensionable
        basic_salary: document.getElementById('basic_salary').value,
        pensionable_percent: document.getElementById('pensionable_percent').value,
        
        // Earnings
        earnings: Array.from(document.querySelectorAll('#earnings-list .dynamic-item')).map(item => {
          const name = item.querySelector('.item-label').textContent.replace(':', '');
          const amountDisplay = item.querySelector('.amount-display');
          const amount = amountDisplay ? amountDisplay.textContent : 'R 0.00';
          return { name, amount };
        }),
        
        // Deductions
        deductions: Array.from(document.querySelectorAll('#deduction-list .dynamic-item')).map(item => {
          const name = item.querySelector('.item-label').textContent.replace(':', '');
          const amountDisplay = item.querySelector('.amount-display');
          const amount = amountDisplay ? amountDisplay.textContent : 'R 0.00';
          return { name, amount };
        }),
        
        // Employer contributions
        employer: Array.from(document.querySelectorAll('#employer-list .dynamic-item')).map(item => {
          const name = item.querySelector('.item-label').textContent.replace(':', '');
          const amountDisplay = item.querySelector('.amount-display');
          const amount = amountDisplay ? amountDisplay.textContent : 'R 0.00';
          return { name, amount };
        }),
        
        // Dependants (for Medical Aid)
        dependants: document.getElementById('dependants').value,
        
        // Calculated values
        total_earnings: document.getElementById('total-earnings').textContent,
        total_deductions: document.getElementById('total-deductions').textContent,
        total_employer: document.getElementById('total-employer').textContent,
        net_pay: document.getElementById('net_pay_val').textContent,
        
        // Timestamp
        saved_at: new Date().toISOString()
      };
      
      const currentUser = sessionStorage.getItem('userID') || 'Admin';
      const idNumber = document.getElementById('id_number').value || 'Unknown';
      const today = new Date();
      const dateSuffix = today.getFullYear().toString().slice(-2) + 
                        (today.getMonth() + 1).toString().padStart(2, '0') + 
                        today.getDate().toString().padStart(2, '0');
      const offerKey = `offer_${currentUser}_${idNumber}_${dateSuffix}`;
      localStorage.setItem(offerKey, JSON.stringify(offerData));
      
      // Show success message
      alert('Offer saved successfully!');
    }
    
    // Load saved offer data
      function loadSavedOffer(offerKey) {
    const savedData = localStorage.getItem(offerKey);
    if (savedData) {
      const offerData = JSON.parse(savedData);
        
        // Show welcome message with current logged-in user
        const currentUser = sessionStorage.getItem('userID') || 'User';
        document.getElementById('welcome-name').textContent = currentUser;
        document.getElementById('welcome-message').style.display = 'block';
        
        // Load personal details
        document.getElementById('first_name').value = offerData.first_name || '';
        document.getElementById('surname').value = offerData.surname || '';
        document.getElementById('id_number').value = offerData.id_number || '';
        document.getElementById('email').value = offerData.email || '';
        document.getElementById('job_title').value = offerData.job_title || '';
        document.getElementById('department').value = offerData.department || '';
        document.getElementById('start_date').value = offerData.start_date || '';
        
        // Load basic salary and pensionable
        document.getElementById('basic_salary').value = offerData.basic_salary || '';
        document.getElementById('pensionable_percent').value = offerData.pensionable_percent || '100';
        
        // Load earnings
        const earningsList = document.getElementById('earnings-list');
        earningsList.innerHTML = '';
        if (offerData.earnings && offerData.earnings.length > 0) {
          offerData.earnings.forEach(earning => {
            const item = document.createElement('div');
            item.className = 'dynamic-item';
            const isOtherItem = !isCustomDescription(earning.name);
            item.innerHTML = `
              <div style="flex: 1; display: flex; align-items: center;">
                <span class="item-label" style="font-weight: bold; min-width: 120px; ${isOtherItem ? 'cursor: pointer; border-bottom: 2px dashed #f47c04; color: #f47c04;' : ''}" title="${isOtherItem ? 'Click to edit description' : ''}">${earning.name}:</span>
                <span style="color: #666; font-size: 0.85em; margin-left: 10px;"></span>
              </div>
              <div style="flex: 1; display: flex; align-items: center; justify-content: flex-end;">
                <span class="amount-display" style="font-weight: 500; margin-right: 10px;">${earning.amount}</span>
                <div class="edit-inputs-container" style="display: none; margin-right: 10px;">
                  ${isOtherItem ? `<input type="text" class="form-control edit-description" value="${earning.name}" style="display: inline-block; max-width: 120px; margin-right: 5px;" placeholder="Description">` : ''}
                  <input type="number" class="form-control edit-input" value="${earning.amount.replace('R ', '')}" style="display: inline-block; max-width: 80px; margin-right: 5px;">
                </div>
                <button type="button" class="btn btn-xs btn-outline-primary edit-btn" onclick="editEarningItem(this);" style="margin-right: 3px; padding: 2px 6px; font-size: 0.75em;" title="Edit item">‚úèÔ∏è</button>
                <button type="button" class="remove-btn" onclick="removeEarningItem(this);" style="padding: 2px 6px; font-size: 0.75em;">√ó</button>
              </div>
            `;
            
            // Add click handler for "Other" item labels
            if (isOtherItem) {
              const label = item.querySelector('.item-label');
              label.addEventListener('click', function() {
                editEarningItem(item.querySelector('.edit-btn'));
              });
            }
            earningsList.appendChild(item);
          });
        }
        
        // Load deductions
        const deductionsList = document.getElementById('deduction-list');
        deductionsList.innerHTML = '';
        if (offerData.deductions && offerData.deductions.length > 0) {
          offerData.deductions.forEach(deduction => {
            const item = document.createElement('div');
            item.className = 'dynamic-item';
            const isOtherItem = !isCustomDescription(deduction.name);
            
            // Handle dependants for Medical Aid
            let dependantsHtml = '';
            let dependantsDisplay = '';
            if (deduction.name === 'Medical Aid (EE)' && offerData.dependants) {
              const dependants = parseInt(offerData.dependants) || 0;
              dependantsHtml = `<input type="number" class="form-control edit-dependants" value="${dependants}" style="display: none; max-width: 60px; margin-right: 5px;" placeholder="Dependants">`;
              dependantsDisplay = ` (${dependants} dependants)`;
            }
            
            item.innerHTML = `
              <div style="flex: 1; display: flex; align-items: center;">
                <span class="item-label" style="font-weight: bold; min-width: 120px; ${isOtherItem ? 'cursor: pointer; border-bottom: 2px dashed #f47c04; color: #f47c04;' : ''}" title="${isOtherItem ? 'Click to edit description' : ''}">${deduction.name}:</span>
                <span style="color: #666; font-size: 0.85em; margin-left: 10px; flex: 1;">${dependantsDisplay}</span>
              </div>
              <div style="flex: 1; display: flex; align-items: center; justify-content: flex-end;">
                <span class="amount-display" style="font-weight: 500; margin-right: 10px;">${deduction.amount}</span>
                <div class="edit-inputs-container" style="display: none; margin-right: 10px;">
                  ${isOtherItem ? `<input type="text" class="form-control edit-description" value="${deduction.name}" style="display: inline-block; max-width: 120px; margin-right: 5px;" placeholder="Description">` : ''}
                  <input type="number" class="form-control edit-input" value="${deduction.amount.replace('R ', '')}" style="display: inline-block; max-width: 80px; margin-right: 5px;">
                </div>
                ${dependantsHtml}
                <button type="button" class="btn btn-xs btn-outline-primary edit-btn" onclick="editDeductionItem(this);" style="margin-right: 3px; padding: 2px 6px; font-size: 0.75em;" title="Edit item">‚úèÔ∏è</button>
                <button type="button" class="remove-btn" onclick="removeDeductionItem(this);" style="padding: 2px 6px; font-size: 0.75em;">√ó</button>
              </div>
            `;
            
            // Add click handler for "Other" item labels
            if (isOtherItem) {
              const label = item.querySelector('.item-label');
              label.addEventListener('click', function() {
                editDeductionItem(item.querySelector('.edit-btn'));
              });
            }
            deductionsList.appendChild(item);
          });
        }
        
        // Load employer contributions
        const employerList = document.getElementById('employer-list');
        employerList.innerHTML = '';
        if (offerData.employer && offerData.employer.length > 0) {
          offerData.employer.forEach(contribution => {
            const item = document.createElement('div');
            item.className = 'dynamic-item';
            const isOtherItem = !isCustomDescription(contribution.name);
            item.innerHTML = `
              <div style="flex: 1; display: flex; align-items: center;">
                <span class="item-label" style="font-weight: bold; min-width: 120px; ${isOtherItem ? 'cursor: pointer; border-bottom: 2px dashed #f47c04; color: #f47c04;' : ''}" title="${isOtherItem ? 'Click to edit description' : ''}">${contribution.name}:</span>
                <span style="color: #666; font-size: 0.85em; margin-left: 10px; flex: 1;"></span>
              </div>
              <div style="flex: 1; display: flex; align-items: center; justify-content: flex-end;">
                <span class="amount-display" style="font-weight: 500; margin-right: 10px;">${contribution.amount}</span>
                <div class="edit-inputs-container" style="display: none; margin-right: 10px;">
                  ${isOtherItem ? `<input type="text" class="form-control edit-description" value="${contribution.name}" style="display: inline-block; max-width: 120px; margin-right: 5px;" placeholder="Description">` : ''}
                  <input type="number" class="form-control edit-input" value="${contribution.amount.replace('R ', '')}" style="display: inline-block; max-width: 80px; margin-right: 5px;">
                </div>
                <button type="button" class="btn btn-xs btn-outline-primary edit-btn" onclick="editEmployerItem(this);" style="margin-right: 3px; padding: 2px 6px; font-size: 0.75em;" title="Edit item">‚úèÔ∏è</button>
                <button type="button" class="remove-btn" onclick="removeEmployerItem(this);" style="padding: 2px 6px; font-size: 0.75em;">√ó</button>
              </div>
            `;
            
            // Add click handler for "Other" item labels
            if (isOtherItem) {
              const label = item.querySelector('.item-label');
              label.addEventListener('click', function() {
                editEmployerItem(item.querySelector('.edit-btn'));
              });
            }
            employerList.appendChild(item);
          });
        }
        
        // Update calculations
        updateTotals();
        updatePensionCalculation();
        
        // Make form editable for regular offers
        makeFormEditable();
        
        // Close modal and ensure main form is visible
        closeOpenOffersModal();
        document.getElementById('main-form').style.display = 'block';
        document.getElementById('popup').style.display = 'none';
        
        // Show loaded message
        alert('Previous offer loaded successfully!');
      }
    }
    
    // Print offer functionality
    function printOffer() {
      // Get form data
      const firstName = document.getElementById('first_name').value || '';
      const surname = document.getElementById('surname').value || '';
      const fullName = `${firstName} ${surname}`.trim() || 'Candidate';
      const jobTitle = document.getElementById('job_title').value || 'Position';
      const basicSalary = document.getElementById('basic_salary').value || '0.00';
      const netPay = document.getElementById('net_pay_val').textContent;
      const paye = document.getElementById('paye_val').textContent;
      const uifEE = document.getElementById('uif_ee_val').textContent;
      const uifER = document.getElementById('uif_er_val').textContent;
      const sdl = document.getElementById('sdl_val').textContent;
      
      // Get earnings
      const earnings = Array.from(document.querySelectorAll('#earnings-list .dynamic-item')).map(item => {
        const name = item.querySelector('span:first-child').textContent.replace(':', '');
        const amountDisplay = item.querySelector('.amount-display');
        const amount = amountDisplay ? amountDisplay.textContent : 'R 0.00';
        return { name, amount };
      });
      
      // Get deductions
      const deductions = Array.from(document.querySelectorAll('#deduction-list .dynamic-item')).map(item => {
        const name = item.querySelector('span:first-child').textContent.replace(':', '');
        const amountDisplay = item.querySelector('.amount-display');
        const amount = amountDisplay ? amountDisplay.textContent : 'R 0.00';
        return { name, amount };
      });
      
      // Get employer contributions
      const employerContributions = Array.from(document.querySelectorAll('#employer-list .dynamic-item')).map(item => {
        const name = item.querySelector('span:first-child').textContent.replace(':', '');
        const amountDisplay = item.querySelector('.amount-display');
        const amount = amountDisplay ? amountDisplay.textContent : 'R 0.00';
        return { name, amount };
      });
      
      // Generate benefits list (only earnings and employer contributions)
      const benefits = [];
      
      // Add Medical Aid if exists (employer contribution only)
      const medicalAidER = employerContributions.find(e => e.name.includes('Medical Aid'));
      if (medicalAidER) {
        benefits.push(`Medical Aid ‚Äì ${medicalAidER.amount}`);
      }
      
      // Add Pension if exists (employer contribution only)
      const pensionER = employerContributions.find(e => e.name.includes('Pension/Provident/RA'));
      if (pensionER) {
        // Find the actual pension item to get percentage information
        const pensionItems = document.querySelectorAll('#employer-list .dynamic-item');
        let pensionPercentage = '';
        
        for (let item of pensionItems) {
          const nameSpan = item.querySelector('span:first-child');
          if (nameSpan && nameSpan.textContent.includes('Pension/Provident/RA')) {
            const percentageSpan = item.querySelector('span[style*="color: #666"]');
            if (percentageSpan && percentageSpan.textContent.includes('%')) {
              pensionPercentage = percentageSpan.textContent.trim();
              break;
            }
          }
        }
        
        if (pensionPercentage) {
          benefits.push(`Pension/Provident Fund (${pensionPercentage}) ‚Äì ${pensionER.amount}`);
        } else {
          benefits.push(`Pension/Provident Fund ‚Äì ${pensionER.amount}`);
        }
      }
      
      // Add other earnings as allowances
      earnings.forEach(earning => {
        if (earning.name !== 'Bonus') {
          benefits.push(`${earning.name} ‚Äì ${earning.amount}`);
        }
      });
      
      // Add other employer contributions
      employerContributions.forEach(contribution => {
        if (!contribution.name.includes('Medical Aid') && !contribution.name.includes('Pension')) {
          benefits.push(`${contribution.name} ‚Äì ${contribution.amount}`);
        }
      });
      
      // Create a print-friendly version with SmartHR branding
      const printWindow = window.open('', '_blank');
      const printContent = `
        <html>
        <head>
          <title>Offer of Employment - ${jobTitle}</title>
          <style>
            @import url('https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&display=swap');
            
            body { 
              font-family: 'Ubuntu', sans-serif; 
              margin: 0; 
              padding: 0; 
              line-height: 1.6; 
              color: #333;
              background: white;
            }
            
            .header-banner {
              background: linear-gradient(135deg, #1e3a5f 0%, #2c5aa0 100%);
              color: white;
              padding: 30px 0;
              text-align: center;
              position: relative;
              overflow: hidden;
            }
            
            .header-banner::before {
              content: '';
              position: absolute;
              bottom: -20px;
              left: 0;
              right: 0;
              height: 40px;
              background: white;
              border-radius: 50% 50% 0 0;
            }
            
            .logo {
              font-size: 2.5em;
              font-weight: 700;
              margin-bottom: 10px;
            }
            
            .logo .go { color: #f47c04; font-style: italic; }
            .logo .smart { color: white; }
            .logo .hr { color: #f47c04; }
            
            .tagline {
              font-size: 1.1em;
              font-weight: 300;
              opacity: 0.9;
            }
            
            .container {
              max-width: 800px;
              margin: 0 auto;
              padding: 40px 20px;
            }
            
            .offer-title {
              font-size: 2.2em;
              font-weight: 700;
              color: #1e3a5f;
              text-align: center;
              margin-bottom: 40px;
              border-bottom: 3px solid #f47c04;
              padding-bottom: 20px;
            }
            
            .greeting {
              font-size: 1.2em;
              margin-bottom: 30px;
              color: #1e3a5f;
            }
            
            .section {
              margin-bottom: 30px;
            }
            
            .section-title {
              font-size: 1.4em;
              font-weight: 600;
              color: #1e3a5f;
              margin-bottom: 15px;
              border-left: 4px solid #f47c04;
              padding-left: 15px;
            }
            
            .benefits-list {
              list-style: none;
              padding: 0;
            }
            
            .benefits-list li {
              padding: 8px 0;
              border-bottom: 1px solid #eee;
              position: relative;
              padding-left: 25px;
            }
            
            .benefits-list li::before {
              content: '‚Ä¢';
              color: #f47c04;
              font-weight: bold;
              font-size: 1.5em;
              position: absolute;
              left: 0;
              top: 5px;
            }
            
            .payslip-section {
              background: white;
              border: 2px solid #1e3a5f;
              border-radius: 8px;
              padding: 20px;
              margin: 30px 0;
              font-family: 'Courier New', monospace;
            }
            
            .payslip-title {
              font-size: 1.2em;
              font-weight: 600;
              color: #1e3a5f;
              text-align: center;
              margin-bottom: 20px;
              border-bottom: 2px solid #f47c04;
              padding-bottom: 10px;
            }
            
            .payslip-grid {
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 20px;
              margin-bottom: 20px;
            }
            
            .payslip-section-left, .payslip-section-right {
              border: 1px solid #ddd;
              border-radius: 5px;
              overflow: hidden;
            }
            
            .payslip-section-header {
              background: #1e3a5f;
              color: white;
              padding: 8px;
              text-align: center;
              font-weight: 600;
              font-size: 0.9em;
            }
            
            .payslip-row {
              display: flex;
              justify-content: space-between;
              padding: 6px 10px;
              border-bottom: 1px solid #eee;
              font-size: 0.85em;
            }
            
            .payslip-row:last-child {
              border-bottom: none;
              background: #e3f2fd;
              font-weight: 600;
            }
            
            .payslip-row .description {
              flex: 1;
              text-align: left;
            }
            
            .payslip-row .amount {
              flex: 0 0 120px;
              text-align: right;
              font-weight: 500;
            }
            
            .net-pay-section {
              grid-column: 1 / -1;
              background: #f8f9fa;
              border: 1px solid #ddd;
              border-radius: 5px;
              padding: 15px;
              text-align: center;
              margin-bottom: 20px;
            }
            
            .net-pay-label {
              font-size: 0.9em;
              color: #666;
              margin-bottom: 5px;
            }
            
            .net-pay-value {
              font-size: 1.4em;
              font-weight: 700;
              color: #1e3a5f;
            }
            
            .ctc-section {
              grid-column: 1 / -1;
              background: #f8f9fa;
              border: 1px solid #ddd;
              border-radius: 5px;
              padding: 10px;
            }
            
            .ctc-row {
              display: flex;
              justify-content: space-between;
              padding: 5px 0;
              font-size: 0.9em;
            }
            
            .ctc-total {
              font-weight: 600;
              font-size: 1.1em;
              color: #1e3a5f;
              border-top: 1px solid #ddd;
              padding-top: 5px;
              margin-top: 5px;
            }
            
            .acceptance-section {
              margin-top: 40px;
              padding: 30px;
              background: #f8f9fa;
              border-radius: 10px;
              border-left: 5px solid #f47c04;
            }
            
            .signature-line {
              border-top: 1px solid #333;
              margin-top: 30px;
              padding-top: 10px;
            }
            
            .signature-box {
              border: 2px solid #1e3a5f;
              border-radius: 5px;
              padding: 20px;
              margin: 20px 0;
              background: white;
            }
            
            .signature-line {
              border-top: 1px solid #333;
              margin-top: 20px;
              padding-top: 10px;
            }
            
            .date-line {
              margin-top: 15px;
              border-top: 1px solid #333;
              padding-top: 10px;
            }
            
            @media print {
              body { margin: 0; }
              .header-banner { break-inside: avoid; }
              .section { break-inside: avoid; }
              .payslip-section { break-inside: avoid; }
            }
          </style>
        </head>
        <body>
          <div class="header-banner">
            <div class="container">
              <div class="logo">
                <span class="go">Go</span><span class="smart">Smart</span><span class="hr">HR</span>
              </div>
              <div class="tagline">Managing the heart of your business</div>
            </div>
          </div>
          
          <div class="container">
            <h1 class="offer-title">Offer of Employment - ${jobTitle}</h1>
            
            <div class="greeting">
              Dear ${firstName || 'Candidate'},
            </div>
            
            <p>We are pleased to offer you the position of <strong>${jobTitle}</strong> at GoSmartHR with an anticipated start date of <strong>${document.getElementById('start_date').value ? new Date(document.getElementById('start_date').value).toLocaleDateString('en-GB') : new Date(Date.now() + 30*24*60*60*1000).toLocaleDateString('en-GB')}</strong>. This offer is subject to the finalisation of any outstanding administrative requirements.</p>
            
            <div class="section">
              <h2 class="section-title">1. Compensation</h2>
              <p>You will receive a gross monthly salary of <strong>R ${parseFloat(basicSalary).toLocaleString('en-ZA', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>, payable on or before the last working day of each month. This salary is subject to statutory deductions as required by law (including PAYE and UIF). Please see below a mock payslip to give an indication of the net pay.</p>
            </div>
            
            <div class="section">
              <h2 class="section-title">2. Benefits</h2>
              <p>In addition to your salary, you will be entitled to the following benefits:</p>
              <ul class="benefits-list">
                ${benefits.length > 0 ? benefits.map(benefit => `<li>${benefit}</li>`).join('') : '<li>Standard company benefits package</li>'}
              </ul>
            </div>
            
            <div class="section">
              <h2 class="section-title">3. Mock Payslip</h2>
              <div class="payslip-section">
                <div class="payslip-title">Monthly Payslip - ${fullName}</div>
                
                <div class="payslip-grid">
                  <!-- Earnings Section -->
                  <div class="payslip-section-left">
                    <div class="payslip-section-header">Earnings</div>
                    <div class="payslip-row">
                      <span class="description">Basic Salary:</span>
                      <span class="amount">R ${parseFloat(basicSalary).toLocaleString('en-ZA', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                    </div>
                    
                    ${earnings.map(earning => `
                      <div class="payslip-row">
                        <span class="description">${earning.name}:</span>
                        <span class="amount">${earning.amount}</span>
                      </div>
                    `).join('')}
                    
                    <div class="payslip-row">
                      <span class="description"><strong>Gross Pay:</strong></span>
                      <span class="amount"><strong>R ${document.getElementById('total-earnings').textContent}</strong></span>
                    </div>
                  </div>
                  
                  <!-- Deductions Section -->
                  <div class="payslip-section-right">
                    <div class="payslip-section-header">Deductions</div>
                    <div class="payslip-row">
                      <span class="description">PAYE:</span>
                      <span class="amount">R ${paye}</span>
                    </div>
                    
                    <div class="payslip-row">
                      <span class="description">UIF:</span>
                      <span class="amount">R ${uifEE}</span>
                    </div>
                    
                    ${deductions.map(deduction => `
                      <div class="payslip-row">
                        <span class="description">${deduction.name}:</span>
                        <span class="amount">${deduction.amount}</span>
                      </div>
                    `).join('')}
                    
                    <div class="payslip-row">
                      <span class="description"><strong>Total Deductions:</strong></span>
                      <span class="amount"><strong>R ${document.getElementById('total-deductions').textContent}</strong></span>
                    </div>
                  </div>
                </div>
                
                <!-- Net Pay Section -->
                <div class="net-pay-section">
                  <div class="net-pay-label">Net Pay</div>
                  <div class="net-pay-value">R ${netPay}</div>
                </div>
                
                <!-- Employer Contributions and CTC Section -->
                <div class="ctc-section">
                  <div class="payslip-section-header">Employer Contributions</div>
                  <div class="ctc-row">
                    <span>UIF:</span>
                    <span>R ${uifER}</span>
                  </div>
                  <div class="ctc-row">
                    <span>SDL:</span>
                    <span>R ${sdl}</span>
                  </div>
                  
                  ${employerContributions.map(contribution => `
                    <div class="ctc-row">
                      <span>${contribution.name}:</span>
                      <span>${contribution.amount}</span>
                    </div>
                  `).join('')}
                  
                  <div class="ctc-row ctc-total">
                    <span><strong>Total CTC:</strong></span>
                    <span><strong>R ${(() => {
                      const totalEarnings = parseFloat(document.getElementById('total-earnings').textContent.replace('R ', ''));
                      const totalEmployer = parseFloat(document.getElementById('total-employer').textContent.replace('R ', ''));
                      const uifERAmount = parseFloat(uifER.replace('R ', ''));
                      const sdlAmount = parseFloat(sdl.replace('R ', ''));
                      const includeUIF = document.getElementById('uif_to_ctc').checked;
                      
                      let ctc = totalEarnings + totalEmployer - sdlAmount;
                      if (!includeUIF) {
                        ctc -= uifERAmount;
                      }
                      
                      return ctc.toLocaleString('en-ZA', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    })()}</strong></span>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="acceptance-section">
              <h2 class="section-title">Acceptance of Offer</h2>
              <ul class="benefits-list">
                <li>Please indicate your acceptance of this offer by signing below and returning a scanned copy to us by <strong>${new Date(Date.now() + 7*24*60*60*1000).toLocaleDateString('en-GB')}</strong>.</li>
                <li>We look forward to welcoming you to GoSmartHR and are confident that you will be a valuable addition to our team.</li>
              </ul>
              
              <div style="margin-top: 30px;">
                <p><strong>Warm regards,</strong></p>
                <p>GoSmartHR Recruitment Team</p>
                <p>GoSmartHR</p>
              </div>
              
              <div class="signature-box">
                <div class="signature-line">
                  <strong>Candidate Acceptance</strong>
                </div>
                <p style="margin: 20px 0;">I, <strong>${fullName}</strong>, accept the offer of employment with GoSmartHR as outlined above.</p>
                <div class="signature-line">
                  <strong>Signature:</strong> ___________________________
                </div>
                <div class="date-line">
                  <strong>Date:</strong> ___________________________
                </div>
              </div>
            </div>
          </div>
        </body>
        </html>
      `;
      
      printWindow.document.write(printContent);
      printWindow.document.close();
      printWindow.print();
    }
    
    // Show new offer popup
    function showNewOfferPopup() {
      // Clear current form
      clearForm();
      
      // Make form editable for new offers
      makeFormEditable();
      
      // Keep the main form visible (don't show popup)
      document.getElementById('popup').style.display = 'none';
      document.getElementById('main-form').style.display = 'block';
      
      // Clear session storage
      sessionStorage.removeItem('userID');
      sessionStorage.removeItem('calculatorMode');
      
      // Show success message
      alert('New offer form cleared! You can now enter new details.');
    }
    
    // Clear form data
    function clearForm() {
      // Clear personal details
      document.getElementById('first_name').value = '';
      document.getElementById('surname').value = '';
      document.getElementById('id_number').value = '';
      document.getElementById('email').value = '';
              document.getElementById('job_title').value = '';
        document.getElementById('department').value = '';
        document.getElementById('start_date').value = '';
      
      // Clear basic salary
      document.getElementById('basic_salary').value = '';
      document.getElementById('pensionable_percent').value = '100';
      
      // Clear lists
      document.getElementById('earnings-list').innerHTML = '';
      document.getElementById('deduction-list').innerHTML = '';
      document.getElementById('employer-list').innerHTML = '';
      
      // Reset and restore dropdowns
      resetDropdowns();
      
      // Hide age display
      document.getElementById('age-display').style.display = 'none';
      
      // Update totals
      updateTotals();
      updatePensionCalculation();
    }
    
    // Reset dropdowns to original state
    function resetDropdowns() {
      // Earnings dropdown
      const earningDropdown = document.getElementById('earning-dropdown');
      earningDropdown.innerHTML = `
        <option value="">Select earning to add</option>
        <option value="Travel Allowance">Travel Allowance</option>
        <option value="Cellphone Allowance">Cellphone Allowance</option>
        <option value="Internet Allowance">Internet Allowance</option>
        <option value="Entertainment Allowance">Entertainment Allowance</option>
        <option value="Medical Allowance">Medical Allowance</option>
        <option value="Bonus">Bonus</option>
        <option value="Other">Other</option>
      `;
      
      // Deductions dropdown
      const deductionDropdown = document.getElementById('deduction-dropdown');
      deductionDropdown.innerHTML = `
        <option value="">Select deduction</option>
        <option value="Pension/Provident/RA">Pension/Provident/RA</option>
        <option value="Medical Aid">Medical Aid</option>
        <option value="Union">Union</option>
        <option value="Personnel Club">Personnel Club</option>
        <option value="Other">Other</option>
      `;
      
      // Employer dropdown
      const employerDropdown = document.getElementById('employer-dropdown');
      employerDropdown.innerHTML = `
        <option value="">Select contribution</option>
        <option value="Pension/Provident/RA">Pension/Provident/RA</option>
        <option value="Medical Aid">Medical Aid</option>
        <option value="Other">Other</option>
      `;
    }
    

  });
</script>

<!-- Global functions for edit and remove operations -->
<script>
  // Edit functions for dynamic items
  function editEarningItem(button) {
    const item = button.closest('.dynamic-item');
    const nameDisplay = item.querySelector('span:first-child');
    const amountDisplay = item.querySelector('.amount-display');
    const editInput = item.querySelector('.edit-input');
    const editDescription = item.querySelector('.edit-description');
    const editBtn = item.querySelector('.edit-btn');
    
    if (editInput.style.display === 'none') {
      // Enter edit mode
      amountDisplay.style.display = 'none';
      
      // Show edit inputs container for "Other" items
      const editInputsContainer = item.querySelector('.edit-inputs-container');
      if (editInputsContainer) {
        editInputsContainer.style.display = 'inline-block';
      } else {
        // Fallback for non-"Other" items
        editInput.style.display = 'inline-block';
      }
      
      // Show description edit ONLY for "Other" items
      if (editDescription && item.querySelector('span:first-child').textContent.includes('Other')) {
        nameDisplay.style.display = 'none';
      }
      
      editBtn.textContent = 'üíæ';
      editBtn.classList.remove('btn-outline-primary');
      editBtn.classList.add('btn-success');
      editInput.focus();
    } else {
      // Save changes
      const newAmount = parseFloat(editInput.value);
      if (!isNaN(newAmount) && newAmount >= 0) {
        amountDisplay.textContent = `R ${newAmount.toFixed(2)}`;
        amountDisplay.style.display = 'inline-block';
        
        // Hide edit inputs container for "Other" items
        const editInputsContainer = item.querySelector('.edit-inputs-container');
        if (editInputsContainer) {
          editInputsContainer.style.display = 'none';
        } else {
          // Fallback for non-"Other" items
          editInput.style.display = 'none';
        }
        
        // Update description if it exists (only for "Other" items)
        if (editDescription && item.querySelector('span:first-child').textContent.includes('Other')) {
          const newDescription = editDescription.value.trim();
          if (newDescription) {
            nameDisplay.textContent = newDescription + ':';
            nameDisplay.style.display = 'inline-block';
          }
        }
        
        editBtn.textContent = '‚úèÔ∏è';
        editBtn.classList.remove('btn-success');
        editBtn.classList.add('btn-outline-primary');
        updateTotals();
      } else {
        alert('Please enter a valid amount');
        editInput.focus();
      }
    }
  }
  
  function editDeductionItem(button) {
    const item = button.closest('.dynamic-item');
    const nameDisplay = item.querySelector('span:first-child');
    const amountDisplay = item.querySelector('.amount-display');
    const editInput = item.querySelector('.edit-input');
    const editDescription = item.querySelector('.edit-description');
    const editBtn = item.querySelector('.edit-btn');
    const dependantsDisplay = item.querySelector('.dependants-display');
    const editDependants = item.querySelector('.edit-dependants');
    
    if (editInput.style.display === 'none') {
      // Enter edit mode
      amountDisplay.style.display = 'none';
      
      // Show edit inputs container for "Other" items
      const editInputsContainer = item.querySelector('.edit-inputs-container');
      if (editInputsContainer) {
        editInputsContainer.style.display = 'inline-block';
      } else {
        // Fallback for non-"Other" items
        editInput.style.display = 'inline-block';
      }
      
      // Show description edit ONLY for "Other" items
      if (editDescription && item.querySelector('span:first-child').textContent.includes('Other')) {
        nameDisplay.style.display = 'none';
      }
      
      // Show dependants edit if Medical Aid
      if (item.querySelector('span:first-child').textContent.includes('Medical Aid')) {
        if (dependantsDisplay) {
          dependantsDisplay.style.display = 'none';
        }
        if (editDependants) {
          editDependants.style.display = 'inline-block';
        }
      }
      
      // Show percentage toggle for Pension/Provident/RA
      if (item.querySelector('span:first-child').textContent.includes('Pension/Provident/RA')) {
        const toggleContainer = document.createElement('div');
        toggleContainer.className = 'edit-toggle-container';
        toggleContainer.style.cssText = 'display: inline-block; margin-left: 5px;';
        toggleContainer.innerHTML = `
          <button type="button" class="btn btn-sm btn-outline-secondary edit-toggle" data-type="percentage" style="margin-right: 2px; font-size: 0.7rem;">%</button>
          <button type="button" class="btn btn-sm btn-outline-secondary edit-toggle" data-type="amount" style="font-size: 0.7rem;">R</button>
        `;
        item.appendChild(toggleContainer);
        
        // Set default active toggle based on current display
        const currentText = amountDisplay.textContent;
        const isPercentage = currentText.includes('%');
        const activeToggle = toggleContainer.querySelector(isPercentage ? '[data-type="percentage"]' : '[data-type="amount"]');
        activeToggle.classList.remove('btn-outline-secondary');
        activeToggle.classList.add('btn-primary');
        
        // Add toggle event listeners
        toggleContainer.querySelectorAll('.edit-toggle').forEach(btn => {
          btn.addEventListener('click', function() {
            const type = this.dataset.type;
            
            // Update active button
            toggleContainer.querySelectorAll('.edit-toggle').forEach(b => {
              b.classList.remove('btn-primary');
              b.classList.add('btn-outline-secondary');
            });
            this.classList.remove('btn-outline-secondary');
            this.classList.add('btn-primary');
            
            // Update input placeholder
            if (type === 'percentage') {
              editInput.placeholder = 'Percentage';
              editInput.setAttribute('max', '100');
            } else {
              editInput.placeholder = 'Amount';
              editInput.removeAttribute('max');
            }
          });
        });
      }
      
      editBtn.textContent = 'üíæ';
      editBtn.classList.remove('btn-outline-primary');
      editBtn.classList.add('btn-success');
      editInput.focus();
    } else {
      // Save changes
      const newAmount = parseFloat(editInput.value);
      if (!isNaN(newAmount) && newAmount >= 0) {
        let displayText = `R ${newAmount.toFixed(2)}`;
        
        // Handle percentage for Pension/Provident/RA
        const toggleContainer = item.querySelector('.edit-toggle-container');
        if (toggleContainer) {
          const activeToggle = toggleContainer.querySelector('.edit-toggle.btn-primary');
          if (activeToggle && activeToggle.dataset.type === 'percentage') {
            const basicSalary = parseFloat(document.getElementById('basic_salary').value) || 0;
            const pensionablePercent = parseFloat(document.getElementById('pensionable_percent').value) || 100;
            const pensionableSalary = (basicSalary * pensionablePercent) / 100;
            const calculatedAmount = (pensionableSalary * newAmount) / 100;
            displayText = `${newAmount}% of pensionable salary = R ${calculatedAmount.toFixed(2)}`;
          }
          toggleContainer.remove();
        }
        
        amountDisplay.textContent = displayText;
        amountDisplay.style.display = 'inline-block';
        
        // Hide edit inputs container for "Other" items
        const editInputsContainer = item.querySelector('.edit-inputs-container');
        if (editInputsContainer) {
          editInputsContainer.style.display = 'none';
        } else {
          // Fallback for non-"Other" items
          editInput.style.display = 'none';
        }
        
        // Update description if it exists
        if (editDescription) {
          const newDescription = editDescription.value.trim();
          if (newDescription) {
            nameDisplay.textContent = newDescription + ':';
            nameDisplay.style.display = 'inline-block';
          }
        }
        
        // Hide dependants edit if Medical Aid
        if (item.querySelector('span:first-child').textContent.includes('Medical Aid')) {
          if (editDependants) {
            editDependants.style.display = 'none';
            const newDependants = parseInt(editDependants.value) || 0;
            if (dependantsDisplay) {
              dependantsDisplay.textContent = `(${newDependants} dependants)`;
              dependantsDisplay.style.display = newDependants > 0 ? 'inline-block' : 'none';
            }
          }
        }
        
        editBtn.textContent = '‚úèÔ∏è';
        editBtn.classList.remove('btn-success');
        editBtn.classList.add('btn-outline-primary');
        updateTotals();
      } else {
        alert('Please enter a valid amount');
        editInput.focus();
      }
    }
  }
  
  function editEmployerItem(button) {
    const item = button.closest('.dynamic-item');
    const nameDisplay = item.querySelector('span:first-child');
    const amountDisplay = item.querySelector('.amount-display');
    const editInput = item.querySelector('.edit-input');
    const editDescription = item.querySelector('.edit-description');
    const editBtn = item.querySelector('.edit-btn');
    
    if (editInput.style.display === 'none') {
      // Enter edit mode
      amountDisplay.style.display = 'none';
      
      // Show edit inputs container for "Other" items
      const editInputsContainer = item.querySelector('.edit-inputs-container');
      if (editInputsContainer) {
        editInputsContainer.style.display = 'inline-block';
      } else {
        // Fallback for non-"Other" items
        editInput.style.display = 'inline-block';
      }
      
      // Show description edit ONLY for "Other" items
      if (editDescription && item.querySelector('span:first-child').textContent.includes('Other')) {
        nameDisplay.style.display = 'none';
      }
      
      // Show percentage toggle for Pension/Provident/RA
      if (item.querySelector('span:first-child').textContent.includes('Pension/Provident/RA')) {
        const toggleContainer = document.createElement('div');
        toggleContainer.className = 'edit-toggle-container';
        toggleContainer.style.cssText = 'display: inline-block; margin-left: 5px;';
        toggleContainer.innerHTML = `
          <button type="button" class="btn btn-sm btn-outline-secondary edit-toggle" data-type="percentage" style="margin-right: 2px; font-size: 0.7rem;">%</button>
          <button type="button" class="btn btn-sm btn-outline-secondary edit-toggle" data-type="amount" style="font-size: 0.7rem;">R</button>
        `;
        item.appendChild(toggleContainer);
        
        // Set default active toggle based on current display
        const currentText = amountDisplay.textContent;
        const isPercentage = currentText.includes('%');
        const activeToggle = toggleContainer.querySelector(isPercentage ? '[data-type="percentage"]' : '[data-type="amount"]');
        activeToggle.classList.remove('btn-outline-secondary');
        activeToggle.classList.add('btn-primary');
        
        // Add toggle event listeners
        toggleContainer.querySelectorAll('.edit-toggle').forEach(btn => {
          btn.addEventListener('click', function() {
            const type = this.dataset.type;
            
            // Update active button
            toggleContainer.querySelectorAll('.edit-toggle').forEach(b => {
              b.classList.remove('btn-primary');
              b.classList.add('btn-outline-secondary');
            });
            this.classList.remove('btn-outline-secondary');
            this.classList.add('btn-primary');
            
            // Update input placeholder
            if (type === 'percentage') {
              editInput.placeholder = 'Percentage';
              editInput.setAttribute('max', '100');
            } else {
              editInput.placeholder = 'Amount';
              editInput.removeAttribute('max');
            }
          });
        });
      }
      
      editBtn.textContent = 'üíæ';
      editBtn.classList.remove('btn-outline-primary');
      editBtn.classList.add('btn-success');
      editInput.focus();
    } else {
      // Save changes
      const newAmount = parseFloat(editInput.value);
      if (!isNaN(newAmount) && newAmount >= 0) {
        let displayText = `R ${newAmount.toFixed(2)}`;
        
        // Handle percentage for Pension/Provident/RA
        const toggleContainer = item.querySelector('.edit-toggle-container');
        if (toggleContainer) {
          const activeToggle = toggleContainer.querySelector('.edit-toggle.btn-primary');
          if (activeToggle && activeToggle.dataset.type === 'percentage') {
            const basicSalary = parseFloat(document.getElementById('basic_salary').value) || 0;
            const pensionablePercent = parseFloat(document.getElementById('pensionable_percent').value) || 100;
            const pensionableSalary = (basicSalary * pensionablePercent) / 100;
            const calculatedAmount = (pensionableSalary * newAmount) / 100;
            displayText = `${newAmount}% of pensionable salary = R ${calculatedAmount.toFixed(2)}`;
          }
          toggleContainer.remove();
        }
        
        amountDisplay.textContent = displayText;
        amountDisplay.style.display = 'inline-block';
        
        // Hide edit inputs container for "Other" items
        const editInputsContainer = item.querySelector('.edit-inputs-container');
        if (editInputsContainer) {
          editInputsContainer.style.display = 'none';
        } else {
          // Fallback for non-"Other" items
          editInput.style.display = 'none';
        }
        
        // Update description if it exists
        if (editDescription) {
          const newDescription = editDescription.value.trim();
          if (newDescription) {
            nameDisplay.textContent = newDescription + ':';
            nameDisplay.style.display = 'inline-block';
          }
        }
        
        editBtn.textContent = '‚úèÔ∏è';
        editBtn.classList.remove('btn-success');
        editBtn.classList.add('btn-outline-primary');
        updateTotals();
      } else {
        alert('Please enter a valid amount');
        editInput.focus();
      }
    }
  }
  

  
  // Complete offer function
  function completeOffer() {
    const currentUser = sessionStorage.getItem('userID') || 'Admin';
    const idNumber = document.getElementById('id_number').value || 'Unknown';
    if (confirm('Are you sure you want to mark this offer as completed? This will move it to completed offers.')) {
      // Get current offer data
      const currentOfferData = localStorage.getItem(`offer_${currentUser}_${idNumber}`);
      if (currentOfferData) {
        const offerData = JSON.parse(currentOfferData);
        
        // Add completion timestamp
        offerData.completed_at = new Date().toISOString();
        offerData.status = 'completed';
        
        // Save to completed offers
        localStorage.setItem(`completed_offer_${currentUser}_${idNumber}`, JSON.stringify(offerData));
        
        // Remove from active offers
        localStorage.removeItem(`offer_${currentUser}_${idNumber}`);
      }
      
      // Clear the form
      clearForm();
      
      // Show popup for new offer
      document.getElementById('popup').style.display = 'flex';
      document.getElementById('main-form').style.display = 'none';
      
      // Clear session storage
      sessionStorage.removeItem('userID');
      sessionStorage.removeItem('calculatorMode');
      
      alert('Offer completed and moved to completed offers!');
    }
  }
  
  // Global functions for modal operations
  function showOpenOffersModal() {
    document.getElementById('open-offers-modal').style.display = 'block';
    populateOffersList();
  }
  
  function closeOpenOffersModal() {
    document.getElementById('open-offers-modal').style.display = 'none';
  }
  
  function populateOffersList() {
    const offersList = document.getElementById('offers-list');
    offersList.innerHTML = '';
    
    const offers = [];
    
    // Get all saved offers from localStorage
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key && key.startsWith('offer_')) {
        try {
          const offerData = JSON.parse(localStorage.getItem(key));
          const parts = key.split('_');
          const username = parts[1];
          const idNumber = parts.slice(2, -1).join('_'); // Remove date suffix from ID
          const dateSuffix = parts[parts.length - 1]; // Get the date suffix
          const firstName = offerData.first_name || '';
          const surname = offerData.surname || '';
          const fullName = `${firstName} ${surname}`.trim() || 'N/A';
          offers.push({
            userId: idNumber,
            name: fullName,
            netPay: offerData.net_pay || 'R 0.00',
            savedAt: offerData.saved_at || 'Unknown',
            dateSuffix: dateSuffix,
            data: offerData,
            key: key
          });
        } catch (e) {
          console.error('Error parsing offer:', key, e);
        }
      }
    }
    
    if (offers.length === 0) {
      offersList.innerHTML = '<p class="text-muted text-center">No saved offers found.</p>';
      return;
    }
    
    // Sort by save date (newest first)
    offers.sort((a, b) => new Date(b.savedAt) - new Date(a.savedAt));
    
    offers.forEach(offer => {
      const offerDiv = document.createElement('div');
      offerDiv.className = 'card mb-2 offer-item';
      offerDiv.setAttribute('data-user-id', offer.userId);
      offerDiv.setAttribute('data-name', offer.name.toLowerCase());
      const displayId = offer.dateSuffix ? `${offer.userId} (${offer.dateSuffix})` : offer.userId;
      offerDiv.innerHTML = `
        <div class="card-body p-3">
          <div class="row align-items-center">
            <div class="col-md-4">
              <strong>ID: ${displayId}</strong><br>
              <small class="text-muted">${offer.name}</small>
            </div>
            <div class="col-md-3">
              <span class="text-success fw-bold">${offer.netPay}</span>
            </div>
            <div class="col-md-3">
              <small class="text-muted">${new Date(offer.savedAt).toLocaleDateString()}</small>
            </div>
            <div class="col-md-2">
              <button type="button" class="btn btn-sm btn-primary" onclick="loadOffer('${offer.key}')" style="margin-right: 5px;">
                Load
              </button>
              <button type="button" class="btn btn-sm btn-danger" onclick="deleteOpenOffer('${offer.key}')">
                üóëÔ∏è
              </button>
            </div>
          </div>
        </div>
      `;
      offersList.appendChild(offerDiv);
    });
  }
  
  function filterOffers(searchTerm) {
    const offerItems = document.querySelectorAll('.offer-item');
    const term = searchTerm.toLowerCase();
    
    offerItems.forEach(item => {
      const userId = item.getAttribute('data-user-id').toLowerCase();
      const name = item.getAttribute('data-name');
      
      if (userId.includes(term) || name.includes(term)) {
        item.style.display = 'block';
      } else {
        item.style.display = 'none';
      }
    });
  }
  
  function deleteOpenOffer(offerKey) {
    if (confirm('Are you sure you want to delete this offer? This action cannot be undone.')) {
      localStorage.removeItem(offerKey);
      populateOffersList(); // Refresh the list
      alert('Offer deleted successfully!');
    }
  }
  
  function loadOffer(offerKey) {
    closeOpenOffersModal();
    
    // Load the offer data
    const offerData = JSON.parse(localStorage.getItem(offerKey));
    if (!offerData) {
      alert('Offer not found!');
      return;
    }
    
    // Set session storage with the username from the key
    const parts = offerKey.split('_');
    const username = parts[1];
    sessionStorage.setItem('userID', username);
    sessionStorage.setItem('calculatorMode', 'basic');
    
    // Load the offer
    loadSavedOffer(offerKey);
    
    // Handle Admin test mode
    if (userId.toLowerCase() === 'admin') {
      document.getElementById('first_name').value = 'DUMMY';
      document.getElementById('surname').value = 'USER';
      document.getElementById('calculated-age').textContent = '35';
      document.getElementById('age-display').style.display = 'inline-block';
      document.getElementById('welcome-name').textContent = 'Admin';
      document.getElementById('welcome-message').style.display = 'block';
    } else {
      // For regular users, calculate age from ID number
      // First hide age display in case we're switching from admin
      document.getElementById('age-display').style.display = 'none';
      calculateAgeFromID(userId);
      // Welcome message is now static - always shows logged-in user
    }
  }
  
  function loadSavedOffer(userId) {
    const savedData = localStorage.getItem(`offer_${userId}`);
    if (savedData) {
      const offerData = JSON.parse(savedData);
      
      // Load personal details
      document.getElementById('first_name').value = offerData.first_name || '';
      document.getElementById('surname').value = offerData.surname || '';
      document.getElementById('id_number').value = offerData.id_number || '';
      document.getElementById('email').value = offerData.email || '';
      document.getElementById('job_title').value = offerData.job_title || '';
      document.getElementById('department').value = offerData.department || '';
      document.getElementById('start_date').value = offerData.start_date || '';
      
      // Load basic salary and pensionable
      document.getElementById('basic_salary').value = offerData.basic_salary || '';
      document.getElementById('pensionable_percent').value = offerData.pensionable_percent || '100';
      
      // Load earnings
      const earningsList = document.getElementById('earnings-list');
      earningsList.innerHTML = '';
      if (offerData.earnings && offerData.earnings.length > 0) {
        offerData.earnings.forEach(earning => {
          const item = document.createElement('div');
          item.className = 'dynamic-item';
          item.innerHTML = `
            <span style="flex: 1; font-weight: bold;">${earning.name}:</span>
            <span style="flex: 1;" class="amount-display">${earning.amount}</span>
            <input type="number" class="form-control edit-input" value="${earning.amount.replace('R ', '')}" style="display: none; max-width: 100px;">
            <button type="button" class="btn btn-sm btn-outline-primary edit-btn" onclick="editEarningItem(this);" style="margin-right: 5px;">‚úèÔ∏è</button>
            <button type="button" class="remove-btn" onclick="removeEarningItem(this);">√ó</button>
          `;
          earningsList.appendChild(item);
        });
      }
      
      // Load deductions
      const deductionsList = document.getElementById('deduction-list');
      deductionsList.innerHTML = '';
      if (offerData.deductions && offerData.deductions.length > 0) {
        offerData.deductions.forEach(deduction => {
          const item = document.createElement('div');
          item.className = 'dynamic-item';
          item.innerHTML = `
            <span style="flex: 1; font-weight: bold;">${deduction.name}:</span>
            <span style="flex: 1;" class="amount-display">${deduction.amount}</span>
            <input type="number" class="form-control edit-input" value="${deduction.amount.replace('R ', '')}" style="display: none; max-width: 100px;">
            <button type="button" class="btn btn-sm btn-outline-primary edit-btn" onclick="editDeductionItem(this);" style="margin-right: 5px;">‚úèÔ∏è</button>
            <button type="button" class="remove-btn" onclick="removeDeductionItem(this);">√ó</button>
          `;
          deductionsList.appendChild(item);
        });
      }
      
      // Load employer contributions
      const employerList = document.getElementById('employer-list');
      employerList.innerHTML = '';
      if (offerData.employer && offerData.employer.length > 0) {
        offerData.employer.forEach(contribution => {
          const item = document.createElement('div');
          item.className = 'dynamic-item';
          item.innerHTML = `
            <span style="flex: 1; font-weight: bold;">${contribution.name}:</span>
            <span style="flex: 1;" class="amount-display">${contribution.amount}</span>
            <input type="number" class="form-control edit-input" value="${contribution.amount.replace('R ', '')}" style="display: none; max-width: 100px;">
            <button type="button" class="btn btn-sm btn-outline-primary edit-btn" onclick="editEmployerItem(this);" style="margin-right: 5px;">‚úèÔ∏è</button>
            <button type="button" class="remove-btn" onclick="removeEmployerItem(this);">√ó</button>
          `;
          employerList.appendChild(item);
        });
      }
      
      // Update calculations
      updateTotals();
      updatePensionCalculation();
      
      // Calculate age from ID number if not admin
      if (userId.toLowerCase() !== 'admin') {
        const idNumber = document.getElementById('id_number').value;
        if (idNumber && idNumber.length >= 6) {
          calculateAgeFromID(idNumber);
        }
      }
      
      // Make form editable for regular offers
      makeFormEditable();
      
      // Show loaded message
      alert('Previous offer loaded successfully!');
    }
  }
  
  function calculateAgeFromID(idNumber) {
    if (idNumber.length >= 6) {
      const year = parseInt(idNumber.substring(0, 2));
      const month = parseInt(idNumber.substring(2, 4));
      const day = parseInt(idNumber.substring(4, 6));
      
      // Determine century (assuming 1900s for years 00-29, 2000s for 30-99)
      const fullYear = year <= 29 ? 2000 + year : 1900 + year;
      
      const birthDate = new Date(fullYear, month - 1, day);
      const today = new Date();
      let age = today.getFullYear() - birthDate.getFullYear();
      
      // Adjust age if birthday hasn't occurred this year
      if (today.getMonth() < birthDate.getMonth() || 
          (today.getMonth() === birthDate.getMonth() && today.getDate() < birthDate.getDate())) {
        age--;
      }
      
      document.getElementById('calculated-age').textContent = age;
      document.getElementById('age-display').style.display = 'inline-block';
    }
  }
  
  function clearForm() {
    // Clear personal details
    document.getElementById('first_name').value = '';
    document.getElementById('surname').value = '';
    document.getElementById('id_number').value = '';
    document.getElementById('email').value = '';
    document.getElementById('job_title').value = '';
    document.getElementById('department').value = '';
    document.getElementById('start_date').value = '';
    
    // Clear basic salary
    document.getElementById('basic_salary').value = '';
    document.getElementById('pensionable_percent').value = '100';
    
    // Clear lists
    document.getElementById('earnings-list').innerHTML = '';
    document.getElementById('deduction-list').innerHTML = '';
    document.getElementById('employer-list').innerHTML = '';
    
    // Reset and restore dropdowns
    resetDropdowns();
    
    // Hide age display
    document.getElementById('age-display').style.display = 'none';
    
    // Update totals
    updateTotals();
    updatePensionCalculation();
    
    // Make form editable
    makeFormEditable();
  }
  
  function resetDropdowns() {
    // Earnings dropdown
    const earningDropdown = document.getElementById('earning-dropdown');
    earningDropdown.innerHTML = `
      <option value="">Select earning to add</option>
      <option value="Travel Allowance">Travel Allowance</option>
      <option value="Cellphone Allowance">Cellphone Allowance</option>
      <option value="Internet Allowance">Internet Allowance</option>
      <option value="Entertainment Allowance">Entertainment Allowance</option>
      <option value="Medical Allowance">Medical Allowance</option>
      <option value="Bonus">Bonus</option>
      <option value="Other">Other</option>
    `;
    
    // Deductions dropdown
    const deductionDropdown = document.getElementById('deduction-dropdown');
    deductionDropdown.innerHTML = `
      <option value="">Select deduction</option>
      <option value="Pension (EE)">Pension (EE)</option>
      <option value="Medical Aid (EE)">Medical Aid (EE)</option>
      <option value="Union">Union</option>
      <option value="Personnel Club">Personnel Club</option>
      <option value="Other">Other</option>
    `;
    
    // Employer dropdown
    const employerDropdown = document.getElementById('employer-dropdown');
    employerDropdown.innerHTML = `
      <option value="">Select contribution</option>
      <option value="Pension (ER)">Pension (ER)</option>
      <option value="Medical Aid (ER)">Medical Aid (ER)</option>
      <option value="Other">Other</option>
    `;
  }
  
  function updatePensionCalculation() {
    const basicSalary = parseFloat(document.getElementById('basic_salary').value) || 0;
    const percentage = parseFloat(document.getElementById('pensionable_percent').value) || 100;
    
    if (basicSalary > 0) {
      const calculatedAmount = (basicSalary * percentage) / 100;
      document.getElementById('pension-calc-amount').textContent = calculatedAmount.toFixed(2);
      document.getElementById('pension-calc').style.display = 'block';
    }
  }
  
  // Completed offers functions
  function showCompletedOffersModal() {
    document.getElementById('completed-offers-modal').style.display = 'block';
    populateCompletedOffersList();
  }
  
  function closeCompletedOffersModal() {
    document.getElementById('completed-offers-modal').style.display = 'none';
  }
  
  function populateCompletedOffersList() {
    const completedOffersList = document.getElementById('completed-offers-list');
    completedOffersList.innerHTML = '';
    
    const completedOffers = [];
    
    // Get all completed offers from localStorage
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key && key.startsWith('completed_offer_')) {
        try {
          const offerData = JSON.parse(localStorage.getItem(key));
          const parts = key.split('_');
          const username = parts[2];
          const idNumber = parts.slice(3).join('_');
          const firstName = offerData.first_name || '';
          const surname = offerData.surname || '';
          const fullName = `${firstName} ${surname}`.trim() || 'N/A';
          completedOffers.push({
            userId: idNumber,
            name: fullName,
            netPay: offerData.net_pay || 'R 0.00',
            completedAt: offerData.completed_at || 'Unknown',
            data: offerData,
            key: key
          });
        } catch (e) {
          console.error('Error parsing completed offer:', key, e);
        }
      }
    }
    
    if (completedOffers.length === 0) {
      completedOffersList.innerHTML = '<p class="text-muted text-center">No completed offers found.</p>';
      return;
    }
    
    // Sort by completion date (newest first)
    completedOffers.sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt));
    
    completedOffers.forEach(offer => {
      const offerDiv = document.createElement('div');
      offerDiv.className = 'card mb-2 completed-offer-item';
      offerDiv.setAttribute('data-user-id', offer.userId);
      offerDiv.setAttribute('data-name', offer.name.toLowerCase());
      offerDiv.innerHTML = `
        <div class="card-body p-3">
          <div class="row align-items-center">
            <div class="col-md-4">
              <strong>ID: ${offer.userId}</strong><br>
              <small class="text-muted">${offer.name}</small>
            </div>
            <div class="col-md-3">
              <span class="text-success fw-bold">${offer.netPay}</span>
            </div>
            <div class="col-md-3">
              <small class="text-muted">Completed: ${new Date(offer.completedAt).toLocaleDateString()}</small>
            </div>
            <div class="col-md-2">
              <button type="button" class="btn btn-sm btn-info" onclick="viewCompletedOffer('${offer.key}')" style="margin-right: 5px;">
                View
              </button>
              <button type="button" class="btn btn-sm btn-danger" onclick="deleteCompletedOffer('${offer.key}')">
                üóëÔ∏è
              </button>
            </div>
          </div>
        </div>
      `;
      completedOffersList.appendChild(offerDiv);
    });
  }
  
  function filterCompletedOffers(searchTerm) {
    const offerItems = document.querySelectorAll('.completed-offer-item');
    const term = searchTerm.toLowerCase();
    
    offerItems.forEach(item => {
      const userId = item.getAttribute('data-user-id').toLowerCase();
      const name = item.getAttribute('data-name');
      
      if (userId.includes(term) || name.includes(term)) {
        item.style.display = 'block';
      } else {
        item.style.display = 'none';
      }
    });
  }
  
  function deleteCompletedOffer(offerKey) {
    if (confirm('Are you sure you want to permanently delete this completed offer? This action cannot be undone.')) {
      localStorage.removeItem(offerKey);
      populateCompletedOffersList(); // Refresh the list
      alert('Completed offer deleted successfully!');
    }
  }
  
  function viewCompletedOffer(offerKey) {
    closeCompletedOffersModal();
    
    // Load the completed offer data
    const savedData = localStorage.getItem(offerKey);
    if (savedData) {
      const offerData = JSON.parse(savedData);
      
      // Show welcome message with current logged-in user
      const currentUser = sessionStorage.getItem('userID') || 'User';
      document.getElementById('welcome-name').textContent = currentUser;
      document.getElementById('welcome-message').style.display = 'block';
      
      // Load personal details
      document.getElementById('first_name').value = offerData.first_name || '';
      document.getElementById('surname').value = offerData.surname || '';
      document.getElementById('id_number').value = offerData.id_number || '';
      document.getElementById('email').value = offerData.email || '';
      document.getElementById('job_title').value = offerData.job_title || '';
      document.getElementById('department').value = offerData.department || '';
      document.getElementById('start_date').value = offerData.start_date || '';
      
      // Load basic salary and pensionable
      document.getElementById('basic_salary').value = offerData.basic_salary || '';
      document.getElementById('pensionable_percent').value = offerData.pensionable_percent || '100';
      
      // Make all form fields read-only for completed offers
      makeFormReadOnly();
      
      // Load earnings
      const earningsList = document.getElementById('earnings-list');
      earningsList.innerHTML = '';
      if (offerData.earnings && offerData.earnings.length > 0) {
        offerData.earnings.forEach(earning => {
          const item = document.createElement('div');
          item.className = 'dynamic-item';
          item.innerHTML = `
            <span style="flex: 1; font-weight: bold;">${earning.name}:</span>
            <span style="flex: 1;" class="amount-display">${earning.amount}</span>
            <input type="number" class="form-control edit-input" value="${earning.amount.replace('R ', '')}" style="display: none; max-width: 100px;">
            <button type="button" class="btn btn-sm btn-outline-primary edit-btn" onclick="editEarningItem(this);" style="margin-right: 5px;">‚úèÔ∏è</button>
            <button type="button" class="remove-btn" onclick="removeEarningItem(this);">√ó</button>
          `;
          earningsList.appendChild(item);
        });
      }
      
      // Load deductions
      const deductionsList = document.getElementById('deduction-list');
      deductionsList.innerHTML = '';
      if (offerData.deductions && offerData.deductions.length > 0) {
        offerData.deductions.forEach(deduction => {
          const item = document.createElement('div');
          item.className = 'dynamic-item';
          
          // Handle dependants for Medical Aid
          let dependantsHtml = '';
          let dependantsDisplay = '';
          if (deduction.name === 'Medical Aid (EE)' && offerData.dependants) {
            const dependants = parseInt(offerData.dependants) || 0;
            dependantsHtml = `<input type="number" class="form-control edit-dependants" value="${dependants}" style="display: none; max-width: 80px; margin-left: 5px;" placeholder="Dependants">`;
            dependantsDisplay = `<span class="dependants-display" style="display: ${dependants > 0 ? 'inline-block' : 'none'}; margin-left: 5px; font-size: 0.8rem; color: #666;">(${dependants} dependants)</span>`;
          }
          
          item.innerHTML = `
            <span style="flex: 1; font-weight: bold;">${deduction.name}:</span>
            <span style="flex: 1;" class="amount-display">${deduction.amount}</span>
            <input type="number" class="form-control edit-input" value="${deduction.amount.replace('R ', '')}" style="display: none; max-width: 100px;">
            ${dependantsHtml}
            ${dependantsDisplay}
            <button type="button" class="btn btn-sm btn-outline-primary edit-btn" onclick="editDeductionItem(this);" style="margin-right: 5px;">‚úèÔ∏è</button>
            <button type="button" class="remove-btn" onclick="removeDeductionItem(this);">√ó</button>
          `;
          deductionsList.appendChild(item);
        });
      }
      
      // Load employer contributions
      const employerList = document.getElementById('employer-list');
      employerList.innerHTML = '';
      if (offerData.employer && offerData.employer.length > 0) {
        offerData.employer.forEach(contribution => {
          const item = document.createElement('div');
          item.className = 'dynamic-item';
          item.innerHTML = `
            <span style="flex: 1; font-weight: bold;">${contribution.name}:</span>
            <span style="flex: 1;" class="amount-display">${contribution.amount}</span>
            <input type="number" class="form-control edit-input" value="${contribution.amount.replace('R ', '')}" style="display: none; max-width: 100px;">
            <button type="button" class="btn btn-sm btn-outline-primary edit-btn" onclick="editEmployerItem(this);" style="margin-right: 5px;">‚úèÔ∏è</button>
            <button type="button" class="remove-btn" onclick="removeEmployerItem(this);">√ó</button>
          `;
          employerList.appendChild(item);
        });
      }
      
      // Update calculations
      updateTotals();
      updatePensionCalculation();
      
      // Show completed message
      alert('Completed offer loaded successfully! (Read-only view)');
    }
  }
  
  function makeFormReadOnly() {
    // Make all input fields read-only
    const inputs = document.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
      input.setAttribute('readonly', true);
      input.style.backgroundColor = '#f8f9fa';
      input.style.cursor = 'not-allowed';
    });
    
    // Disable all buttons except print and navigation
    const buttons = document.querySelectorAll('button:not([id*="print"]):not([id*="open"]):not([id*="completed"]):not([id*="new"]):not(.btn-close)');
    buttons.forEach(button => {
      button.disabled = true;
      button.style.opacity = '0.5';
      button.style.cursor = 'not-allowed';
    });
    
    // Hide add buttons and dropdowns
    const addButtons = document.querySelectorAll('[id*="add-"]');
    addButtons.forEach(button => {
      button.style.display = 'none';
    });
    
    const dropdowns = document.querySelectorAll('select[id*="-dropdown"]');
    dropdowns.forEach(dropdown => {
      dropdown.style.display = 'none';
    });
    
    // Add a visual indicator that this is read-only
    const header = document.querySelector('.header-band h2');
    if (header) {
      header.innerHTML += ' <span class="badge bg-secondary">Read-Only View</span>';
    }
  }
  
  function makeFormEditable() {
    // Make all input fields editable
    const inputs = document.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
      input.removeAttribute('readonly');
      input.style.backgroundColor = '';
      input.style.cursor = '';
    });
    
    // Enable all buttons
    const buttons = document.querySelectorAll('button');
    buttons.forEach(button => {
      button.disabled = false;
      button.style.opacity = '';
      button.style.cursor = '';
    });
    
    // Show add buttons and dropdowns
    const addButtons = document.querySelectorAll('[id*="add-"]');
    addButtons.forEach(button => {
      button.style.display = '';
    });
    
    const dropdowns = document.querySelectorAll('select[id*="-dropdown"]');
    dropdowns.forEach(dropdown => {
      dropdown.style.display = '';
    });
    
    // Remove read-only indicator
    const header = document.querySelector('.header-band h2');
    if (header) {
      header.innerHTML = header.innerHTML.replace(' <span class="badge bg-secondary">Read-Only View</span>', '');
    }
  }

  // Global remove functions (accessible from onclick handlers)
  function removeEarningItem(button) {
    const item = button.closest('.dynamic-item');
    const earningName = item.querySelector('span:first-child').textContent.replace(':', '');
    const dropdown = document.getElementById('earning-dropdown');
    
    // Only add back to dropdown if it's not an "Other" item or custom description
    if (earningName !== 'Other' && !isCustomDescription(earningName)) {
      // Check if option already exists
      const existingOption = dropdown.querySelector(`option[value="${earningName}"]`);
      if (!existingOption) {
        const option = document.createElement('option');
        option.value = earningName;
        option.textContent = earningName;
        dropdown.appendChild(option);
      }
    }
    
    // Always remove the item, regardless of type
    item.remove();
    updateTotals();
  }

  function removeDeductionItem(button) {
    console.log('removeDeductionItem called');
    const item = button.closest('.dynamic-item');
    console.log('Item to remove:', item);
    const deductionName = item.querySelector('span:first-child').textContent.replace(':', '');
    console.log('Deduction name:', deductionName);
    const dropdown = document.getElementById('deduction-dropdown');
    
    // Only add back to dropdown if it's not an "Other" item or custom description
    if (deductionName !== 'Other' && !isCustomDescription(deductionName)) {
      // Check if option already exists
      const existingOption = dropdown.querySelector(`option[value="${deductionName}"]`);
      if (!existingOption) {
        const option = document.createElement('option');
        option.value = deductionName;
        option.textContent = deductionName;
        dropdown.appendChild(option);
      }
    }
    
    // Always remove the item, regardless of type
    item.remove();
    updateTotals();
  }

  function removeEmployerItem(button) {
    const item = button.closest('.dynamic-item');
    const employerName = item.querySelector('span:first-child').textContent.replace(':', '');
    const dropdown = document.getElementById('employer-dropdown');
    
    // Only add back to dropdown if it's not an "Other" item or custom description
    if (employerName !== 'Other' && !isCustomDescription(employerName)) {
      // Check if option already exists
      const existingOption = dropdown.querySelector(`option[value="${employerName}"]`);
      if (!existingOption) {
        const option = document.createElement('option');
        option.value = employerName;
        option.textContent = employerName;
        dropdown.appendChild(option);
      }
    }
    
    // Always remove the item, regardless of type
    item.remove();
    updateTotals();
  }

  // Global helper function for checking custom descriptions
  function isCustomDescription(name) {
    // Check if this is a custom description (not a standard dropdown option)
    const standardEarnings = [
      'Travel Allowance', 'Cellphone Allowance', 'Internet Allowance', 
      'Entertainment Allowance', 'Medical Allowance', 'Bonus', 'Other'
    ];
    const standardDeductions = [
      'Pension/Provident/RA', 'Medical Aid', 'Union', 'Personnel Club', 'Other'
    ];
    const standardEmployer = [
      'Pension/Provident/RA', 'Medical Aid', 'Other'
    ];
    
    // Return true if it's NOT a standard item (i.e., it's a custom description)
    return !standardEarnings.includes(name) && 
           !standardDeductions.includes(name) && 
           !standardEmployer.includes(name);
  }
</script>
</body>
</html>
