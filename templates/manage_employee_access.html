<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rand Water - Employee Access Management</title>
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --randwater-primary: #0066CC;
      --randwater-secondary: #00A3E0;
      --randwater-accent: #FF6600;
      --randwater-dark: #003366;
      --randwater-light: #E6F3FF;
    }
    
    body {
      font-family: 'Ubuntu', sans-serif;
      background-color: #f8f9fa;
      font-size: 0.9rem;
      margin: 0;
      padding: 0;
    }
    
    .randwater-header {
      background: linear-gradient(135deg, var(--randwater-primary) 0%, var(--randwater-secondary) 100%);
      color: white;
      padding: 1.5rem 0;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .randwater-logo {
      max-height: 80px;
      filter: brightness(0) invert(1);
    }
    
    .gosmarthr-logo {
      max-height: 100px;
      margin-top: 8px;
    }
    
    .branding {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
      margin-right: 1rem;
    }
    
    .powered-by {
      font-size: 0.7rem;
      opacity: 0.9;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
      color: var(--randwater-accent);
    }
    
    .page-header {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-left: 4px solid var(--randwater-accent);
    }
    
    .page-header h1 {
      color: var(--randwater-dark);
      margin-bottom: 0.5rem;
    }
    
    .page-header p {
      color: #6c757d;
      margin: 0;
    }
    
    .stats-overview {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }
    
    .stat-item {
      text-align: center;
      padding: 1rem;
      background: var(--randwater-light);
      border-radius: 8px;
      border: 2px solid var(--randwater-secondary);
    }
    
    .stat-item .number {
      font-size: 2rem;
      font-weight: 700;
      color: var(--randwater-accent);
      display: block;
    }
    
    .stat-item .label {
      color: var(--randwater-dark);
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .table-container {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .table-header {
      background: linear-gradient(135deg, var(--randwater-primary) 0%, var(--randwater-secondary) 100%);
      color: white;
      padding: 1rem 1.5rem;
      margin: -1.5rem -1.5rem 1.5rem -1.5rem;
      border-radius: 12px 12px 0 0;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1.1rem;
      font-weight: bold;
    }
    
    .table th {
      background-color: var(--randwater-light);
      border-color: var(--randwater-secondary);
      color: var(--randwater-dark);
      font-weight: 600;
    }
    
    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .status-active {
      background-color: #d4edda;
      color: #155724;
    }
    
    .status-expired {
      background-color: #f8d7da;
      color: #721c24;
    }
    
    .status-pending {
      background-color: #fff3cd;
      color: #856404;
    }
    
    .status-submitted {
      background-color: #d1ecf1;
      color: #0c5460;
    }
    
    .action-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    .btn-sm {
      padding: 0.25rem 0.5rem;
      font-size: 0.8rem;
    }
    
    .filters {
      background: var(--randwater-light);
      border: 1px solid var(--randwater-secondary);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .filters h6 {
      color: var(--randwater-dark);
      margin-bottom: 1rem;
    }
    
    .filter-row {
      display: flex;
      gap: 1rem;
      align-items: end;
      flex-wrap: wrap;
    }
    
    .filter-group {
      flex: 1;
      min-width: 200px;
    }
    
    .filter-group label {
      font-size: 0.8rem;
      color: var(--randwater-dark);
      margin-bottom: 0.25rem;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--randwater-primary) 0%, var(--randwater-secondary) 100%);
      border: none;
      border-radius: 8px;
      padding: 0.75rem 2rem;
      font-weight: 600;
    }
    
    .btn-outline-secondary {
      border-color: var(--randwater-secondary);
      color: var(--randwater-secondary);
    }
    
    .btn-outline-secondary:hover {
      background-color: var(--randwater-secondary);
      color: white;
    }
  </style>
</head>
<body>
  <div class="randwater-header">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-6">
          <div class="d-flex align-items-center">
            <img src="{{ config.company_logo }}" alt="Rand Water Logo" class="randwater-logo me-3">
            <div>
              <div class="tagline">Employee Access Management</div>
            </div>
          </div>
        </div>
        <div class="col-md-6 text-end">
                     <div class="branding">
             <img src="/static/images/smarthr_logo_white.png" alt="SmartHR Logo" class="gosmarthr-logo">
           </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Navigation -->
    <div class="mb-4">
      <a href="{{ url_for('randwater_admin_panel') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </a>
    </div>

    <!-- Page Header -->
    <div class="page-header">
      <h1><i class="fas fa-users-cog"></i> Employee Access Management</h1>
      <p>Monitor and manage employee access to the Package Builder system</p>
    </div>

    <!-- Access Configuration Info -->
    <div class="alert alert-info mb-4">
      <h6><i class="fas fa-info-circle"></i> Access Configuration Information</h6>
      <div class="row">
        <div class="col-md-6">
          <strong>Where Access Dates Are Set:</strong><br>
          • <strong>Upload SAP Data Page:</strong> Configure default access period (currently 30 days)<br>
          • <strong>System:</strong> Automatically calculates expiry dates when employees are uploaded<br>
          • <strong>Manual Extension:</strong> Use "Extend" buttons to add more time for specific employees
        </div>
        <div class="col-md-6">
          <strong>How It Works:</strong><br>
          • <strong>Access Granted:</strong> Set to current date when employee is uploaded<br>
          • <strong>Access Expires:</strong> Automatically calculated based on configured period<br>
          • <strong>Days Remaining:</strong> Shows actual number of days left (not dates)
        </div>
      </div>
    </div>

    <!-- Access Configuration Section -->
    <div class="card mb-4">
      <div class="card-header">
        <h5><i class="fas fa-cog"></i> Access Configuration</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <label for="accessPeriod" class="form-label">Default Access Period (Days)</label>
            <input type="number" class="form-control" id="accessPeriod" name="accessPeriod" value="30" min="1" max="365">
            <div class="form-text">This sets how long employees will have access to the Package Builder system when uploaded via SAP data.</div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Current Settings</label>
            <div class="alert alert-info">
              <strong>Access Period:</strong> <span id="currentPeriod">30</span> days<br>
              <strong>Band Restriction:</strong> Only O, P, Q grade bands<br>
              <strong>Auto-Expiry:</strong> Access automatically expires after the set period
            </div>
          </div>
        </div>
        <div class="mt-3">
          <button type="button" class="btn btn-primary" onclick="updateAccessPeriod()">
            <i class="fas fa-save"></i> Update Access Period
          </button>
        </div>
      </div>
    </div>

    <!-- Statistics Overview -->
    <div class="stats-overview">
      <h5><i class="fas fa-chart-bar"></i> Access Overview</h5>
      <div class="stats-grid">
        <div class="stat-item">
          <span class="number">{{ stats.total_employees }}</span>
          <span class="label">Total Employees</span>
        </div>
        <div class="stat-item">
          <span class="number">{{ stats.active_access }}</span>
          <span class="label">Active Access</span>
        </div>
        <div class="stat-item">
          <span class="number">{{ stats.expired_access }}</span>
          <span class="label">Expired Access</span>
        </div>
        <div class="stat-item">
          <span class="number">{{ stats.pending_submissions }}</span>
          <span class="label">Pending Submissions</span>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters">
      <h6><i class="fas fa-filter"></i> Filter Options</h6>
      <div class="filter-row">
        <div class="filter-group">
          <label>Grade Band</label>
          <select class="form-select" id="gradeBandFilter">
            <option value="">All Bands</option>
            <option value="O">O Band</option>
            <option value="P">P Band</option>
            <option value="Q">Q Band</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Access Status</label>
          <select class="form-select" id="statusFilter">
            <option value="">All Statuses</option>
            <option value="active">Active</option>
            <option value="expired">Expired</option>
            <option value="revoked">Revoked</option>
            <option value="pending">Pending</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Package Status</label>
          <select class="form-select" id="packageStatusFilter">
            <option value="">All Package Statuses</option>
            <option value="pending">Pending</option>
            <option value="submitted">Submitted</option>
          </select>
        </div>
        <div class="filter-group">
          <button class="btn btn-primary" onclick="applyFilters()">
            <i class="fas fa-search"></i> Apply Filters
          </button>
        </div>
      </div>
    </div>

    <!-- Bulk Actions -->
    <div class="table-container">
      <div class="table-header">
        <i class="fas fa-tasks"></i> Bulk Actions
      </div>
      <div class="p-3">
        <!-- Date Range Selection -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="accessStartDate" class="form-label">Access Start Date</label>
            <input type="date" class="form-control" id="accessStartDate" value="{{ today_date }}">
          </div>
          <div class="col-md-6">
            <label for="accessEndDate" class="form-label">Access End Date</label>
            <input type="date" class="form-control" id="accessEndDate" value="{{ default_end_date }}">
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="row">
          <div class="col-md-6">
            <button class="btn btn-warning me-2" onclick="bulkExtendAccess()">
              <i class="fas fa-clock"></i> Extend Access (Custom Dates)
            </button>
            <button class="btn btn-info me-2" onclick="bulkGrantAccess()">
              <i class="fas fa-key"></i> Grant Access (Custom Dates)
            </button>
          </div>
          <div class="col-md-6 text-end">
            <button class="btn btn-danger me-2" onclick="bulkRevokeAccess()">
              <i class="fas fa-ban"></i> Revoke Selected Access
            </button>
            <button class="btn btn-success" onclick="bulkEmailCredentials()">
              <i class="fas fa-envelope"></i> Email User Details
            </button>
          </div>
        </div>
        
        <!-- Selection Info -->
        <div class="mt-3">
          <small class="text-muted">
            <span id="selectedCount">0</span> employee(s) selected
          </small>
        </div>
      </div>
    </div>

    <!-- Employee Access Table -->
    <div class="table-container">
      <div class="table-header">
        <div class="d-flex justify-content-between align-items-center w-100">
          <div>
            <i class="fas fa-users"></i> Employee Access Details
          </div>
          <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#employeeTableContainer" aria-expanded="true" aria-controls="employeeTableContainer">
            <i class="fas fa-eye"></i> Show/Hide Details
          </button>
        </div>
      </div>
      <div class="collapse show" id="employeeTableContainer">
        <div class="table-responsive">
          <table class="table table-hover" id="employeeTable">
            <thead>
              <tr>
                <th>
                  <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                </th>
                <th>Employee ID</th>
                <th>Grade Band</th>
                <th>Username</th>
                <th>Access Granted</th>
                <th>Access Expires</th>
                <th>Access Status</th>
                <th>Package Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for employee in active_employees %}
              <tr data-grade="{{ employee.grade_band }}" data-status="{{ 'revoked' if employee.access_status == 'REVOKED' else ('active' if not employee.is_expired else 'expired') }}" data-package="{{ 'submitted' if employee.package_submitted else 'pending' }}">
                <td>
                  <input type="checkbox" class="employee-select" value="{{ employee.employee_id }}" data-username="{{ employee.username }}">
                </td>
                <td>{{ employee.employee_id }}</td>
                <td>{{ employee.grade_band }}</td>
                <td>{{ employee.username }}</td>
                <td>{{ employee.access_granted.split('T')[0] if employee.access_granted else 'N/A' }}</td>
                <td>{{ employee.access_expires.split('T')[0] if employee.access_expires else 'N/A' }}</td>
                <td>
                  {% if employee.access_status == 'REVOKED' %}
                    <span class="badge bg-danger">Access Revoked</span>
                  {% elif employee.access_expires and not employee.is_expired %}
                    <span class="status-badge status-active">
                      Active ({{ employee.days_remaining }} days left)
                    </span>
                  {% else %}
                    <span class="badge bg-warning">Expired</span>
                  {% endif %}
                </td>
                <td>
                  {% if employee.package_submitted %}
                    <span class="status-badge status-submitted">Submitted</span>
                  {% else %}
                    <span class="status-badge status-pending">Pending</span>
                  {% endif %}
                </td>
                <td>
                  <div class="action-buttons">
                    <button class="btn btn-sm btn-outline-primary" onclick="viewEmployee('{{ employee.employee_id }}')">
                      <i class="fas fa-eye"></i> View
                    </button>
                    {% if employee.access_status == 'REVOKED' %}
                      <button class="btn btn-sm btn-outline-success" onclick="grantAccess('{{ employee.employee_id }}')">
                        <i class="fas fa-key"></i> Restore Access
                      </button>
                    {% elif not employee.is_expired %}
                      <button class="btn btn-sm btn-outline-warning" onclick="extendAccess('{{ employee.employee_id }}')">
                        <i class="fas fa-clock"></i> Extend
                      </button>
                      <button class="btn btn-sm btn-outline-danger" onclick="revokeAccess('{{ employee.employee_id }}')">
                        <i class="fas fa-ban"></i> Revoke
                      </button>
                    {% else %}
                      <button class="btn btn-sm btn-outline-success" onclick="grantAccess('{{ employee.employee_id }}')">
                        <i class="fas fa-key"></i> Grant
                      </button>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Employee View Modal -->
  <div class="modal fade" id="employeeViewModal" tabindex="-1" aria-labelledby="employeeViewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header" style="background: linear-gradient(135deg, var(--randwater-primary) 0%, var(--randwater-secondary) 100%); color: white;">
          <h5 class="modal-title" id="employeeViewModalLabel">
            <i class="fas fa-user"></i> Employee User Details
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="employeeViewContent">
            <!-- Content will be loaded here -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="saveEmployeeChanges()">
            <i class="fas fa-save"></i> Save Changes
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Access period management
    function updateAccessPeriod() {
      const newPeriod = document.getElementById('accessPeriod').value;
      if (newPeriod < 1 || newPeriod > 365) {
        alert('Access period must be between 1 and 365 days');
        return;
      }
      
      // Update the display
      document.getElementById('currentPeriod').textContent = newPeriod;
      
      // Save to localStorage for persistence (you can enhance this to save to backend)
      localStorage.setItem('defaultAccessPeriod', newPeriod);
      
      alert(`Access period updated to ${newPeriod} days. This will apply to new SAP uploads.`);
    }
    
    // Employee selection management
    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAll');
      const checkboxes = document.querySelectorAll('.employee-select');
      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
      });
      updateSelectedCount();
    }
    
    function updateSelectedCount() {
      const selectedCheckboxes = document.querySelectorAll('.employee-select:checked');
      const count = selectedCheckboxes.length;
      document.getElementById('selectedCount').textContent = count;
      
      // Update select all checkbox state
      const totalCheckboxes = document.querySelectorAll('.employee-select').length;
      const selectAll = document.getElementById('selectAll');
      selectAll.indeterminate = count > 0 && count < totalCheckboxes;
      selectAll.checked = count === totalCheckboxes;
    }
    
    // Add event listeners to individual checkboxes
    document.addEventListener('DOMContentLoaded', function() {
      // Load saved access period
      const savedPeriod = localStorage.getItem('defaultAccessPeriod');
      if (savedPeriod) {
        document.getElementById('accessPeriod').value = savedPeriod;
        document.getElementById('currentPeriod').textContent = savedPeriod;
      }
      
      const checkboxes = document.querySelectorAll('.employee-select');
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
      });
      updateSelectedCount();
      applyFilters();
    });
    
    function applyFilters() {
      const gradeFilter = document.getElementById('gradeBandFilter').value;
      const statusFilter = document.getElementById('statusFilter').value;
      const packageFilter = document.getElementById('packageStatusFilter').value;
      
      const rows = document.querySelectorAll('#employeeTable tbody tr');
      
      rows.forEach(row => {
        let show = true;
        
        if (gradeFilter && row.dataset.grade !== gradeFilter) {
          show = false;
        }
        
        if (statusFilter && row.dataset.status !== statusFilter) {
          show = false;
        }
        
        if (packageFilter && row.dataset.package !== packageFilter) {
          show = false;
        }
        
        row.style.display = show ? '' : 'none';
      });
      
      // Update selection count after filtering
      updateSelectedCount();
    }
    
    function getSelectedEmployees() {
      const selectedCheckboxes = document.querySelectorAll('.employee-select:checked');
      const employees = [];
      selectedCheckboxes.forEach(checkbox => {
        employees.push({
          id: checkbox.value,
          username: checkbox.dataset.username
        });
      });
      return employees;
    }
    
    function validateDateRange() {
      const startDate = document.getElementById('accessStartDate').value;
      const endDate = document.getElementById('accessEndDate').value;
      
      if (!startDate || !endDate) {
        alert('Please select both start and end dates');
        return false;
      }
      
      if (new Date(startDate) >= new Date(endDate)) {
        alert('End date must be after start date');
        return false;
      }
      
      return true;
    }
    
    function bulkExtendAccess() {
      const selectedEmployees = getSelectedEmployees();
      if (selectedEmployees.length === 0) {
        alert('Please select employees to extend access for');
        return;
      }
      
      if (!validateDateRange()) return;
      
      const startDate = document.getElementById('accessStartDate').value;
      const endDate = document.getElementById('accessEndDate').value;
      
      if (confirm(`Extend access for ${selectedEmployees.length} selected employees from ${startDate} to ${endDate}?`)) {
        // Show loading state
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
        btn.disabled = true;
        
        // Call backend API to update access dates
        fetch('/api/update-employee-access', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            employee_ids: selectedEmployees.map(emp => emp.id),
            access_granted: startDate,
            access_expires: endDate,
            action: 'extend'
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Show success message briefly then reload
            alert(`Successfully updated access for ${data.updated_count} employees!`);
            // Force reload immediately after alert
            window.location.href = window.location.href + '?t=' + Date.now();
          } else {
            alert(`Error: ${data.error}`);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error updating access dates. Please try again.');
        })
        .finally(() => {
          // Restore button
          btn.innerHTML = originalText;
          btn.disabled = false;
        });
      }
    }
    
    function bulkGrantAccess() {
      const selectedEmployees = getSelectedEmployees();
      if (selectedEmployees.length === 0) {
        alert('Please select employees to grant access for');
        return;
      }
      
      if (!validateDateRange()) return;
      
      const startDate = document.getElementById('accessStartDate').value;
      const endDate = document.getElementById('accessEndDate').value;
      
      if (confirm(`Grant access for ${selectedEmployees.length} selected employees from ${startDate} to ${endDate}?`)) {
        // Show loading state
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
        btn.disabled = true;
        
        // Call backend API to update access dates
        fetch('/api/update-employee-access', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            employee_ids: selectedEmployees.map(emp => emp.id),
            access_granted: startDate,
            access_expires: endDate,
            action: 'grant'
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Show success message briefly then reload
            alert(`Successfully updated access for ${data.updated_count} employees!`);
            // Force reload immediately after alert
            window.location.href = window.location.href + '?t=' + Date.now();
          } else {
            alert(`Error: ${data.error}`);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error updating access dates. Please try again.');
        })
        .finally(() => {
          // Restore button
          btn.innerHTML = originalText;
          btn.disabled = false;
        });
      }
    }
    
    function bulkRevokeAccess() {
      const selectedEmployees = getSelectedEmployees();
      if (selectedEmployees.length === 0) {
        alert('Please select employees to revoke access for');
        return;
      }
      
      if (confirm(`Revoke access for ${selectedEmployees.length} selected employees? This action cannot be undone.`)) {
        // Show loading state
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Revoking...';
        btn.disabled = true;
        
        // Call backend API to revoke access
        fetch('/api/revoke-employee-access', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            employee_ids: selectedEmployees.map(emp => emp.id),
            action: 'revoke'
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert(`Successfully revoked access for ${data.revoked_count} employees!`);
            // Reload the page to show updated data
            location.reload();
          } else {
            alert(`Error: ${data.error}`);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error revoking access. Please try again.');
        })
        .finally(() => {
          // Restore button
          btn.innerHTML = originalText;
          btn.disabled = false;
        });
      }
    }
    
    
    function viewEmployee(employeeId) {
      console.log('viewEmployee called with ID:', employeeId);
      
      // Check if modal element exists
      const modalElement = document.getElementById('employeeViewModal');
      if (!modalElement) {
        console.error('Modal element not found!');
        return;
      }
      
      // Check if Bootstrap is loaded
      if (typeof bootstrap === 'undefined') {
        console.error('Bootstrap not loaded!');
        return;
      }
      
      // Show loading state
      const modal = new bootstrap.Modal(modalElement);
      const content = document.getElementById('employeeViewContent');
      content.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Loading employee details...</p></div>';
      modal.show();
      
      console.log('Modal shown, fetching employee details...');
      
      // Fetch employee details
      fetch(`/admin/randwater/employee-details/${employeeId}`)
        .then(response => response.json())
        .then(data => {
          console.log('Employee data received:', data);
          console.log('data.success value:', data.success);
          console.log('typeof data.success:', typeof data.success);
          if (data.success) {
            console.log('Calling displayEmployeeDetails with:', data.employee, data.package);
            displayEmployeeDetails(data.employee, data.package);
          } else {
            console.log('data.success is falsy, showing error. data.error:', data.error);
            content.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
          }
        })
        .catch(error => {
          console.error('Error:', error);
          content.innerHTML = '<div class="alert alert-danger">Error loading employee details</div>';
        });
    }
    
         function displayEmployeeDetails(employee, package) {
       const content = document.getElementById('employeeViewContent');
       
       const accessStatus = employee.status === 'ACTIVE' ? 
         '<span class="badge bg-success">Active</span>' : 
         '<span class="badge bg-danger">Inactive</span>';
       
       content.innerHTML = `
         <div class="row">
           <div class="col-md-6">
             <h6 class="text-primary"><i class="fas fa-id-card"></i> Basic Information</h6>
             <table class="table table-sm">
               <tr><td><strong>Employee ID:</strong></td><td>${employee.employee_id}</td></tr>
               <tr><td><strong>Grade Band:</strong></td><td>${employee.grade_band}</td></tr>
               <tr><td><strong>Access Status:</strong></td><td>${accessStatus}</td></tr>
             </table>
           </div>
           <div class="col-md-6">
             <h6 class="text-primary"><i class="fas fa-clock"></i> Access Information</h6>
             <table class="table table-sm">
               <tr><td><strong>Access Granted:</strong></td><td>${formatDate(employee.access_granted)}</td></tr>
               <tr><td><strong>Access Expires:</strong></td><td>${formatDate(employee.access_expires)}</td></tr>
               <tr><td><strong>Last Login:</strong></td><td>${employee.last_login ? formatDate(employee.last_login) : 'Never'}</td></tr>
               <tr><td><strong>Package Submitted:</strong></td><td>${employee.package_submitted ? 'Yes' : 'No'}</td></tr>
               ${employee.submission_date ? `<tr><td><strong>Submission Date:</strong></td><td>${formatDate(employee.submission_date)}</td></tr>` : ''}
             </table>
           </div>
         </div>
         <hr>
         <div class="row">
           <div class="col-12">
             <h6 class="text-primary"><i class="fas fa-key"></i> Login Credentials (Editable)</h6>
             <div class="alert alert-warning">
               <small class="text-muted">You can edit the username and password below. Click "Save Changes" to update.</small>
             </div>
             <div class="row">
               <div class="col-md-6">
                 <label for="editUsername" class="form-label">Username</label>
                 <input type="text" class="form-control" id="editUsername" value="${employee.username}" placeholder="Enter username">
               </div>
               <div class="col-md-6">
                 <label for="editPassword" class="form-label">Password</label>
                 <div class="input-group">
                   <input type="text" class="form-control" id="editPassword" value="${employee.password}" placeholder="Enter password">
                   <button class="btn btn-outline-secondary" type="button" onclick="generateNewPassword()">
                     <i class="fas fa-random"></i> Generate
                   </button>
                 </div>
               </div>
             </div>
             <div class="mt-3">
               <small class="text-muted">
                 <i class="fas fa-info-circle"></i> 
                 <strong>Note:</strong> After changing credentials, the employee will need to use the new username and password to log in.
               </small>
             </div>
           </div>
         </div>
       `;
       
       // Store employee data for saving
       window.currentEditingEmployee = employee;
     }
    
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      try {
        return new Date(dateString).toLocaleDateString('en-ZA', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (e) {
        return dateString;
      }
    }
    
    function extendAccess(employeeId) {
      if (confirm('Extend access for employee ' + employeeId + '?')) {
        // Implement extend access
        alert('Access extended for: ' + employeeId);
      }
    }
    
    function revokeAccess(employeeId) {
      if (confirm('Revoke access for employee ' + employeeId + '? This action cannot be undone.')) {
        // Implement revoke access
        alert('Access revoked for: ' + employeeId);
      }
    }
    
    function grantAccess(employeeId) {
      if (confirm('Grant/Restore access for employee ' + employeeId + '?')) {
        // Call the restore access API
        fetch('/api/restore-employee-access', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            employee_ids: [employeeId]
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert(`Successfully restored access for ${data.restored_count} employee(s)!`);
            // Force reload immediately after alert
            window.location.href = window.location.href + '?t=' + Date.now();
          } else {
            alert(`Error: ${data.error}`);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error restoring access: ' + error.message);
        });
      }
    }
     
     function generateNewPassword() {
       const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
       let password = '';
       for (let i = 0; i < 8; i++) {
         password += chars.charAt(Math.floor(Math.random() * chars.length));
       }
       document.getElementById('editPassword').value = password;
     }
     
     function saveEmployeeChanges() {
       if (!window.currentEditingEmployee) {
         alert('No employee data to save');
         return;
       }
       
       const newUsername = document.getElementById('editUsername').value.trim();
       const newPassword = document.getElementById('editPassword').value.trim();
       
       if (!newUsername || !newPassword) {
         alert('Username and password cannot be empty');
         return;
       }
       
       if (newUsername.length < 3) {
         alert('Username must be at least 3 characters long');
         return;
       }
       
       if (newPassword.length < 6) {
         alert('Password must be at least 6 characters long');
         return;
       }
       
       // Show confirmation
       if (confirm(`Update credentials for employee ${window.currentEditingEmployee.employee_id}?\n\nNew Username: ${newUsername}\nNew Password: ${newPassword}`)) {
         // TODO: Implement API call to update credentials
         alert(`Credentials updated successfully!\n\nUsername: ${newUsername}\nPassword: ${newPassword}\n\nPlease share these new credentials with the employee.`);
         
         // Close modal
         const modal = bootstrap.Modal.getInstance(document.getElementById('employeeViewModal'));
         if (modal) {
           modal.hide();
         }
       }
     }
     
     function bulkEmailCredentials() {
       console.log('Email User Details clicked');
       
       // Get all active employees
       const employees = {{ employees|tojson|safe }};
       console.log('Total employees:', employees.length);
       
       if (!employees || employees.length === 0) {
         alert('No active employees to email');
         return;
       }
       
       // Show the email modal
       const emailModal = new bootstrap.Modal(document.getElementById('emailCredentialsModal'));
       
       // Populate the employee list
       const employeeList = document.getElementById('emailEmployeeList');
       employeeList.innerHTML = '';
       
       employees.forEach((emp, index) => {
         const row = document.createElement('div');
         row.className = 'employee-email-row mb-3 p-3 border rounded';
         row.innerHTML = `
           <div class="row align-items-center">
             <div class="col-md-1">
               <input type="checkbox" class="form-check-input employee-checkbox" id="emp_${emp.employee_id}" value="${emp.employee_id}">
             </div>
             <div class="col-md-4">
               <label for="emp_${emp.employee_id}" class="form-check-label">
                 <strong>${emp.employee_id}</strong><br/>
                 <small>${emp.first_name} ${emp.surname}</small><br/>
                 <small class="text-muted">Band ${emp.grade_band}</small>
               </label>
             </div>
             <div class="col-md-7">
               <input type="email" class="form-control" id="email_${emp.employee_id}" placeholder="Enter email address" disabled>
             </div>
           </div>
         `;
         employeeList.appendChild(row);
         
         // Enable email input when checkbox is checked
         const checkbox = row.querySelector(`#emp_${emp.employee_id}`);
         const emailInput = row.querySelector(`#email_${emp.employee_id}`);
         
         checkbox.addEventListener('change', function() {
           emailInput.disabled = !this.checked;
           if (!this.checked) {
             emailInput.value = '';
           }
         });
       });
       
       emailModal.show();
     }
     
     function selectAllEmployees() {
       const checkboxes = document.querySelectorAll('.employee-checkbox');
       const selectAllBtn = document.getElementById('selectAllBtn');
       const allChecked = Array.from(checkboxes).every(cb => cb.checked);
       
       checkboxes.forEach(checkbox => {
         checkbox.checked = !allChecked;
         checkbox.dispatchEvent(new Event('change'));
       });
       
       selectAllBtn.textContent = allChecked ? 'Select All' : 'Deselect All';
     }
     
     function sendCredentialEmails() {
       console.log('=== SEND CREDENTIAL EMAILS DEBUG START ===');
       
       const employees = {{ employees|tojson|safe }};
       console.log('Available employees:', employees);
       console.log('Number of employees:', employees.length);
       
       const selectedEmployees = [];
       
       // Collect selected employees with their email addresses
       employees.forEach(emp => {
         console.log(`Processing employee: ${emp.employee_id} (${emp.first_name} ${emp.surname})`);
         
         const checkbox = document.getElementById(`emp_${emp.employee_id}`);
         const emailInput = document.getElementById(`email_${emp.employee_id}`);
         
         console.log(`Checkbox element:`, checkbox);
         console.log(`Email input element:`, emailInput);
         
         if (checkbox) {
           console.log(`Checkbox checked: ${checkbox.checked}`);
         }
         
         if (emailInput) {
           console.log(`Email input value: "${emailInput.value}"`);
         }
         
         if (checkbox && checkbox.checked) {
           const email = emailInput.value.trim();
           console.log(`Employee ${emp.employee_id} is selected with email: "${email}"`);
           
           if (!email) {
             console.error(`Missing email for employee ${emp.employee_id}`);
             alert(`Please enter an email address for ${emp.employee_id} (${emp.first_name} ${emp.surname})`);
             throw new Error('Missing email');
           }
           
           // Validate email format
           const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
           if (!emailRegex.test(email)) {
             console.error(`Invalid email format for employee ${emp.employee_id}: ${email}`);
             alert(`Invalid email address for ${emp.employee_id}: ${email}`);
             throw new Error('Invalid email');
           }
           
           const employeeData = {
             employee_id: emp.employee_id,
             first_name: emp.first_name,
             surname: emp.surname,
             email: email
           };
           
           console.log(`Adding employee to selected list:`, employeeData);
           selectedEmployees.push(employeeData);
         } else {
           console.log(`Employee ${emp.employee_id} not selected or checkbox not found`);
         }
       });
       
       console.log('Final selected employees:', selectedEmployees);
       console.log('Number of selected employees:', selectedEmployees.length);
       
       if (selectedEmployees.length === 0) {
         console.error('No employees selected');
         alert('Please select at least one employee');
         return;
       }
       
       // Confirm before sending
       if (!confirm(`Send login credentials to ${selectedEmployees.length} employee(s)?`)) {
         console.log('User cancelled email sending');
         return;
       }
       
       console.log('User confirmed email sending');
       
       // Show loading state
       const sendBtn = document.getElementById('sendEmailBtn');
       console.log('Send button element:', sendBtn);
       sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
       sendBtn.disabled = true;
       
       const requestData = {
         employees: selectedEmployees
       };
       
       console.log('Request data being sent:', requestData);
       console.log('Request URL: /api/send-employee-credentials');
       console.log('Request method: POST');
       
       // Send emails
       fetch('/api/send-employee-credentials', {
         method: 'POST',
         headers: {
           'Content-Type': 'application/json'
         },
         body: JSON.stringify(requestData)
       })
       .then(response => {
         console.log('Response received:', response);
         console.log('Response status:', response.status);
         console.log('Response statusText:', response.statusText);
         console.log('Response headers:', response.headers);
         
         // Always try to parse JSON, even for error responses
         return response.json().then(data => {
           console.log('Parsed response data:', data);
           
           // Display debug information in console
           if (data.debug) {
             console.log('=== BACKEND DEBUG INFORMATION ===');
             data.debug.forEach(debugLine => {
               console.log(debugLine);
             });
             console.log('=== END BACKEND DEBUG ===');
           }
           
           if (!response.ok) {
             console.error(`HTTP Error: ${response.status} ${response.statusText}`);
             console.error('Error response data:', data);
             throw new Error(`HTTP error! status: ${response.status}`);
           }
           
           return data;
         }).catch(jsonError => {
           console.error('Failed to parse JSON response:', jsonError);
           console.log('Response text:', response.text());
           throw new Error(`Failed to parse response: ${jsonError.message}`);
         });
       })
       .then(data => {
         console.log('Response data:', data);
         
         // Display debug information in console
         if (data.debug) {
           console.log('=== BACKEND DEBUG INFORMATION ===');
           data.debug.forEach(debugLine => {
             console.log(debugLine);
           });
           console.log('=== END BACKEND DEBUG ===');
         }
         
         if (data.success) {
           console.log('Email sending successful');
           alert(`Successfully sent credentials to ${data.sent_count} employee(s)!`);
           
           // Close modal
           const modal = bootstrap.Modal.getInstance(document.getElementById('emailCredentialsModal'));
           modal.hide();
         } else if (data.message) {
           console.log('Email sending successful');
           alert(data.message);
           
           // Close modal
           const modal = bootstrap.Modal.getInstance(document.getElementById('emailCredentialsModal'));
           modal.hide();
         } else {
           console.error('Email sending failed:', data.error);
           console.error('Failed details:', data.details);
           alert(`Error: ${data.error}`);
         }
       })
       .catch(error => {
         console.error('=== SEND CREDENTIAL EMAILS ERROR ===');
         console.error('Error type:', typeof error);
         console.error('Error message:', error.message);
         console.error('Error stack:', error.stack);
         console.error('Full error object:', error);
         alert('Failed to send emails. Please try again.');
       })
       .finally(() => {
         console.log('Restoring send button state');
         sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Emails';
         sendBtn.disabled = false;
         console.log('=== SEND CREDENTIAL EMAILS DEBUG END ===');
       });
     }
  </script>
  
  <!-- Email Credentials Modal -->
  <div class="modal fade" id="emailCredentialsModal" tabindex="-1" aria-labelledby="emailCredentialsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="emailCredentialsModalLabel">
            <i class="fas fa-envelope"></i> Email Employee Credentials
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> 
            Select employees and enter their email addresses to send login credentials.
          </div>
          
          <div class="mb-3">
            <button class="btn btn-sm btn-outline-primary" id="selectAllBtn" onclick="selectAllEmployees()">
              <i class="fas fa-check-square"></i> Select All
            </button>
          </div>
          
          <div id="emailEmployeeList">
            <!-- Employee list will be populated here -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times"></i> Cancel
          </button>
          <button type="button" class="btn btn-success" id="sendEmailBtn" onclick="sendCredentialEmails()">
            <i class="fas fa-paper-plane"></i> Send Emails
          </button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
